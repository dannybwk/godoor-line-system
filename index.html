<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æœå¤š - æœ¬æœˆèª²ç¨‹å ±å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { background: #fffbe7; font-size: 1.55rem; }
    .calendar-section, .form-section { background: white; border-radius: 10px; padding: 1.5rem; margin-top: 1rem; }
    .event-checkbox { margin-bottom: 1rem; }
    .event-title { font-weight: bold; font-size: 1.7rem; }
    .event-info { font-size: 1.5rem; color: #666; }
    .required { color: red; margin-left: 4px; }
    .footer { text-align: center; padding: 1rem; font-size: 1.3rem; }
    .custom-question { margin-bottom: 1rem; }
  </style>
</head>
<body>
  <div class="container py-3">
    <h1 id="site-title" class="text-center mb-2" style="color:#f07f2f; font-size:2.2rem; font-weight:bold;"></h1>
    <h4 class="text-orange mb-3">
      <img src="https://cdn-icons-png.flaticon.com/128/747/747310.png" style="width:28px;margin-right:6px"/>
      æœ¬æœˆèª²ç¨‹å ±å
    </h4>

    <div id="event-list" class="calendar-section">
      <h5 class="mb-3">ğŸ“… è«‹å‹¾é¸æƒ³å ±åçš„èª²ç¨‹</h5>
      <div id="events-container">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="form-section">
      <h5 class="mb-3">ğŸ“ åŸºæœ¬è³‡æ–™</h5>
      <form id="signup-form">
        <div class="mb-3">
          <label for="name">å§“å <span class="required">(å¿…å¡«)</span></label>
          <input type="text" class="form-control" id="name" name="name" placeholder="è«‹è¼¸å…¥å§“å" required>
        </div>
        <div class="mb-3">
          <label for="lineName">LINEä¸Šçš„åå­— <span class="required">(å¿…å¡«)</span></label>
          <input type="text" class="form-control" id="lineName" name="lineName" placeholder="è«‹è¼¸å…¥LINEä¸Šçš„åå­—" required>
        </div>
        <div class="mb-3">
          <label for="gender">æ€§åˆ¥</label>
          <select class="form-select" id="gender" name="gender">
            <option value="">è«‹é¸æ“‡</option>
            <option value="ç”·">ç”·</option>
            <option value="å¥³">å¥³</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="phone">æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">(å¿…å¡«)</span></label>
          <input type="tel" class="form-control" id="phone" name="phone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼" required>
        </div>
        <div class="mb-3">
          <label for="email">é›»å­éƒµä»¶</label>
          <input type="email" class="form-control" id="email" name="email" placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶">
        </div>
        <div id="custom-fields"></div>
        <input type="hidden" id="lineId" name="lineId">
        <button type="submit" class="btn btn-warning w-100">âœ… é€å‡ºå ±å</button>
      </form>
    </div>

    <div class="footer">
      Powered by <span style="color:#f07f2f;font-weight:bold">æœå¤š</span><br>
      <img src="https://godoor.umita.tw/wp-content/uploads/2023/10/%E6%9E%9C%E5%A4%9A-Logo-%E7%B0%A1%E5%96%AE%E5%BD%A9%E7%89%88-300x300.png" width="50" />
    </div>
  </div>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbzJZVHlsTwQ_QyEyjVXR5lF4sLcTR2HCQdNIu8t0-4qWPJCU6k1fkpWhZSIw_k_ELAC/exec";
    const urlParams = new URLSearchParams(window.location.search);
    const siteParam = urlParams.get('site');

    if (siteParam) {
      document.getElementById('site-title').textContent = siteParam;
    }

    liff.init({ liffId: '2007618883-ewZnj9Py' }).then(() => {
      return liff.getProfile();
    }).then(profile => {
      document.getElementById('lineId').value = profile.userId;
    }).catch(err => {
      console.error('LIFF åˆå§‹åŒ–å¤±æ•—', err);
    });

    let eventMap = {}; // æ´»å‹•ID -> customQuestions å°æ‡‰

    const fetchEvents = async () => {
      try {
        const res = await fetch(`${API_BASE}?mode=events&site=${siteParam}`);
        const data = await res.json();
        renderEvents(data);
      } catch (e) {
        document.getElementById('events-container').innerHTML = 'âŒ ç„¡æ³•è¼‰å…¥æ´»å‹•ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
        console.error('æ´»å‹•è¼‰å…¥å¤±æ•—ï¼š', e);
      }
    };

    const renderEvents = (events) => {
      const container = document.getElementById('events-container');
      container.innerHTML = '';
      eventMap = {}; // reset

      events.forEach(event => {
        const id = event['æ´»å‹•ID'];
        const title = event['æ´»å‹•æ¨™é¡Œ'];
        const date = event['æ´»å‹•æ—¥æœŸ'];
        const time = event['é–‹å§‹æ™‚é–“'];
        const teacher = event['è¬›å¸«'];
        const note = event['å‚™è¨»'] || '';
        let parsed = {};
        try { parsed = JSON.parse(note); } catch {}
        if (parsed.customQuestions) eventMap[id] = parsed.customQuestions;

        const checkbox = document.createElement('div');
        checkbox.className = 'form-check event-checkbox';
        checkbox.innerHTML = `
          <input class="form-check-input" type="checkbox" value="${id}" id="event-${id}" name="events">
          <label class="form-check-label" for="event-${id}">
            <div class="event-title">${title}</div>
            <div class="event-info">${date} ${time} - ${teacher}</div>
          </label>
        `;
        container.appendChild(checkbox);
      });

      document.querySelectorAll('input[name="events"]').forEach(input => {
        input.addEventListener('change', updateCustomFields);
      });
    };

    function updateCustomFields() {
      const selected = [...document.querySelectorAll('input[name="events"]:checked')].map(e => e.value);
      const container = document.getElementById('custom-fields');
      container.innerHTML = '';
      selected.forEach(id => {
        const questions = eventMap[id];
        if (questions) {
          questions.forEach((q, idx) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-question';
            const name = `custom_${id}_${idx}`;
            let html = `<label>${q.label}</label>`;
            if (q.type === 'text') {
              html += `<input type="text" name="${name}" class="form-control">`;
            } else if (q.type === 'radio' && Array.isArray(q.options)) {
              q.options.forEach(opt => {
                html += `<div class="form-check">
                  <input class="form-check-input" type="radio" name="${name}" value="${opt}">
                  <label class="form-check-label">${opt}</label>
                </div>`;
              });
            }
            wrapper.innerHTML = html;
            container.appendChild(wrapper);
          });
        }
      });
    }

    const submitForm = async (e) => {
      e.preventDefault();
      const form = document.getElementById('signup-form');
      const formData = new FormData(form);
      const events = [...document.querySelectorAll('input[name="events"]:checked')].map(e => e.value);
      if (events.length === 0) {
        alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹èª²ç¨‹');
        return;
      }
      for (const ev of events) {
        const body = new URLSearchParams();
        body.set('action', 'register');
        body.set('eventId', ev);
        for (const [k, v] of formData.entries()) {
          body.set(k, v);
        }
        await fetch(API_BASE, { method: 'POST', body });

        await fetch(API_BASE, {
          method: 'POST',
          body: new URLSearchParams({
            action: 'pushMessage',
            eventId: ev,
            lineId: formData.get('lineId')
          })
        });
      }
      alert('å ±åæˆåŠŸï¼');
      form.reset();
      updateCustomFields();
    };

    document.getElementById('signup-form').addEventListener('submit', submitForm);
    fetchEvents();
  </script>
</body>
</html>
