<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æœå¤šæ´»å‹•å ±åç³»çµ±</title>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: #f5f5f5;
    color: #333;
    line-height: 1.6;
    font-size: 18px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.site-title {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    color: white;
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 20px;
    text-align: center;
    font-size: 32px;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
}

.header {
    background: #ff9800;
    color: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
    text-align: center;
}

.header h1 {
    font-size: 28px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.logo-icon {
    width: 64px;
    height: 64px;
    vertical-align: middle;
    margin-right: 8px;
    border-radius: 4px;
    background: white;
    padding: 2px;
}

.site-info {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #2196f3;
}

.view-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
    font-weight: 500;
    transition: all 0.2s;
    min-height: 44px;
}

.btn-primary {
    background: #ff9800;
    color: white;
}

.btn-primary:hover {
    background: #f57c00;
}

.btn-outline {
    background: white;
    color: #ff9800;
    border: 2px solid #ff9800;
}

.btn-outline:hover {
    background: #ff9800;
    color: white;
}

.btn-active {
    background: #f57c00;
    color: white;
}

/* é¡æ»¿ç›¸é—œæ¨£å¼ */
.btn-disabled {
    background: #ccc !important;
    color: #666 !important;
    cursor: not-allowed !important;
    border-color: #ccc !important;
}

.capacity-info {
    display: inline-block;
    margin-left: 8px;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: bold;
}

.capacity-available {
    background: #4caf50;
    color: white;
}

.capacity-warning {
    background: #ff9800;
    color: white;
}

.capacity-full {
    background: #f44336;
    color: white;
}

.full-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(244, 67, 54, 0.9);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    border-radius: 12px;
    z-index: 10;
}

/* æœˆæ›†æ¨£å¼ */
.calendar-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 30px;
}

.calendar-header {
    background: #ff9800;
    color: white;
    padding: 20px;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.month-nav {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 4px;
    transition: background 0.2s;
}

.month-nav:hover {
    background: rgba(255, 255, 255, 0.1);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
}

.calendar-weekday {
    background: #fff3e0;
    padding: 15px 8px;
    text-align: center;
    font-weight: bold;
    color: #f57c00;
    border-bottom: 1px solid #ffe0b2;
}

.calendar-day {
    min-height: 140px;
    border: 1px solid #f0f0f0;
    padding: 10px;
    position: relative;
    background: white;
}

.calendar-day.other-month {
    background: #fafafa;
    color: #999;
}

.calendar-day.today {
    background: #fff3e0;
    border-color: #ff9800;
}

.day-number {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 4px;
    color: #666;
}

.day-events {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.calendar-event {
    background: #ff9800;
    color: white;
    padding: 6px 8px;
    border-radius: 4px;
    font-size: 16px;
    line-height: 1.3;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 3px;
    position: relative;
}

.calendar-event:hover {
    background: #f57c00;
    transform: translateY(-1px);
}

.calendar-event.selected {
    background: #4caf50;
    box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
}

.calendar-event.full {
    background: #f44336;
    cursor: not-allowed;
}

.calendar-event.warning {
    background: #ff9800;
}

/* åˆ—è¡¨æ¨£å¼ */
.events-grid {
    display: grid;
    gap: 20px;
}

.event-card {
    background: white;
    border: 2px solid #ddd;
    border-radius: 12px;
    padding: 24px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.event-card:hover {
    border-color: #ff9800;
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.15);
}

.event-card.selected {
    border-color: #4caf50;
    background: #f1f8e9;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
}

.event-card.full {
    background: #ffebee;
    border-color: #f44336;
    cursor: not-allowed;
}

.event-card.full:hover {
    border-color: #f44336;
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.15);
}

.event-header {
    display: flex;
    align-items: flex-start;
    margin-bottom: 15px;
}

.event-checkbox {
    width: 20px;
    height: 20px;
    margin-right: 15px;
    margin-top: 2px;
    flex-shrink: 0;
}

.event-checkbox:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.event-title {
    font-size: 20px;
    font-weight: 600;
    color: #ff9800;
    margin: 0;
    line-height: 1.3;
    flex-grow: 1;
}

.event-title.full {
    color: #f44336;
}

.event-details {
    color: #666;
    font-size: 18px;
    line-height: 1.5;
}

.event-details div {
    margin-bottom: 8px;
}

/* è¡¨å–®æ¨£å¼ */
.form-section {
    background: white;
    padding: 30px;
    border-radius: 12px;
    margin-top: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
    font-size: 18px;
}

.required {
    color: #f44336;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 18px;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: #ff9800;
    box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
}

.custom-fields {
    background: #fff3e0;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
    border-left: 4px solid #ff9800;
}

.custom-fields h4 {
    color: #f57c00;
    margin-bottom: 15px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 20px;
}

.error {
    background: #ffebee;
    color: #c62828;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #f44336;
    font-size: 18px;
}

.success {
    background: #e8f5e8;
    color: #2e7d32;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #4caf50;
}

/* é é¢åº•éƒ¨æ¨£å¼ */
.footer {
    text-align: center;
    padding: 40px 20px 20px;
    margin-top: 50px;
    border-top: 1px solid #e0e0e0;
}

.footer-text {
    color: #666;
    font-size: 16px;
    margin-bottom: 15px;
}

.footer-logo {
    width: 80px;
    height: 80px;
    margin: 0 auto;
    display: block;
    border-radius: 8px;
    opacity: 0.8;
}

.hidden {
    display: none;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
    .container {
        padding: 15px;
    }

    .header h1 {
        font-size: 24px;
        flex-direction: column;
        gap: 8px;
    }

    .logo-icon {
        width: 56px;
        height: 56px;
        margin-right: 0;
        margin-bottom: 4px;
    }

    .view-toggle {
        flex-direction: column;
    }

    .calendar-header {
        font-size: 20px;
        padding: 15px;
    }

    .calendar-day {
        min-height: 100px;
        padding: 6px;
    }

    .calendar-event {
        font-size: 14px;
        padding: 4px 6px;
        margin-bottom: 2px;
    }

    .event-card {
        padding: 20px;
    }

    .event-title {
        font-size: 18px;
    }

    .form-control {
        font-size: 18px;
    }
}

@media (max-width: 480px) {
    .calendar-weekday {
        padding: 8px 4px;
        font-size: 14px;
    }

    .calendar-day {
        min-height: 70px;
        padding: 3px;
    }

    .day-number {
        font-size: 12px;
    }

    .calendar-event {
        font-size: 11px;
        padding: 2px 3px;
        margin-bottom: 1px;
    }
}
</style>
</head>
<body>
<div class="container">
    <!-- æ“šé»åç¨±å¤§æ¨™é¡Œ -->
    <div id="siteTitleHeader" class="site-title hidden"></div>

    <div class="header">
        <h1>
            <img src="https://godoor.umita.tw/wp-content/uploads/2023/10/%E6%9E%9C%E5%A4%9A-Logo-%E7%B0%A1%E5%96%AE%E5%BD%A9%E7%89%88-300x300.png" 
                 alt="æœå¤š" 
                 class="logo-icon"> 
            æ´»å‹•å ±åè¡¨å–®
        </h1>
        <p>é¸æ“‡æ‚¨æƒ³åƒåŠ çš„èª²ç¨‹</p>
    </div>

    <div id="siteInfo" class="site-info hidden">
        <strong>ğŸ“ ç•¶å‰æ“šé»ï¼š</strong><span id="currentSite"></span>
    </div>

    <div class="view-toggle">
        <button class="btn btn-primary" onclick="loadEvents()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
        <button class="btn btn-outline" id="calendarViewBtn" onclick="switchToCalendar()">ğŸ“… æœˆæ›†æª¢è¦–</button>
        <button class="btn btn-outline" id="listViewBtn" onclick="switchToList()">ğŸ“‹ åˆ—è¡¨æª¢è¦–</button>
        <button class="btn btn-outline" onclick="clearSelection()">ğŸ—‘ï¸ æ¸…é™¤é¸æ“‡</button>
    </div>

    <!-- æœˆæ›†æª¢è¦– -->
    <div id="calendarView" class="calendar-container hidden">
        <div class="calendar-header">
            <button class="month-nav" onclick="changeMonth(-1)">â€¹</button>
            <span id="currentMonth"></span>
            <button class="month-nav" onclick="changeMonth(1)">â€º</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <!-- åˆ—è¡¨æª¢è¦– -->
    <div id="listView">
        <div id="eventsContainer">
            <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <!-- å·²é¸èª²ç¨‹æ‘˜è¦ -->
    <div id="selectedSummary" class="hidden" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
        <h3 style="color: #4caf50; margin-bottom: 10px;">âœ… å·²é¸æ“‡çš„èª²ç¨‹</h3>
        <div id="selectedList"></div>
    </div>

    <div class="form-section">
        <h3 style="margin-bottom: 20px; color: #ff9800;">ğŸ“ å ±åè³‡æ–™</h3>
        <form id="signupForm">
            <div class="form-group">
                <label class="form-label">å§“å <span class="required">*</span></label>
                <input type="text" class="form-control" name="name" required placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
            </div>

            <div class="form-group">
                <label class="form-label">LINEåç¨± <span class="required">*</span></label>
                <input type="text" class="form-control" name="lineName" required placeholder="è«‹è¼¸å…¥æ‚¨åœ¨LINEä¸Šé¡¯ç¤ºçš„åç¨±">
            </div>

            <div class="form-group">
                <label class="form-label">æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">*</span></label>
                <input type="tel" class="form-control" name="phone" required placeholder="ä¾‹å¦‚ï¼š0912345678">
            </div>

            <div class="form-group">
                <label class="form-label">é›»å­éƒµä»¶</label>
                <input type="email" class="form-control" name="email" placeholder="ä¾‹å¦‚ï¼šexample@gmail.com">
            </div>

            <div class="form-group">
                <label class="form-label">æ€§åˆ¥</label>
                <select class="form-control" name="gender">
                    <option value="">è«‹é¸æ“‡</option>
                    <option value="ç”·">ç”·</option>
                    <option value="å¥³">å¥³</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">å¹´é½¡</label>
                <input type="number" class="form-control" name="age" min="1" max="120" placeholder="è«‹è¼¸å…¥æ‚¨çš„å¹´é½¡">
            </div>

            <div class="form-group">
                <label class="form-label">å‚™è¨»</label>
                <textarea class="form-control" name="note" rows="3" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚æˆ–æƒ³è¦è£œå……çš„è³‡è¨Šï¼Œè«‹åœ¨æ­¤å¡«å¯«"></textarea>
            </div>
            <!-- éš±è—çš„ LINE ID æ¬„ä½ -->
                <input type="hidden" name="lineId" id="lineIdField">
            <!-- è‡ªè¨‚æ¬„ä½å€åŸŸ -->
            <div id="customFields" class="hidden"></div>

            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 18px;">
                âœ… é€å‡ºå ±å
            </button>
        </form>
    </div>
    
    <!-- é é¢åº•éƒ¨ -->
    <div class="footer">
        <div class="footer-text">Powered by æœå¤š</div>
        <img src="https://godoor.umita.tw/wp-content/uploads/2023/10/%E6%9E%9C%E5%A4%9A-Logo-%E7%B0%A1%E5%96%AE%E5%BD%A9%E7%89%88-300x300.png" 
             alt="æœå¤š" 
             class="footer-logo">
    </div>
</div>

<script>
// é…ç½®
const API_URL = 'https://script.google.com/macros/s/AKfycbxpDCRA2PJXLy8ssWwG3NO4QZzg87gmUdB1vHWjYNdf9jmz-ku0yfnovhtfz58ep0oE/exec';

// LIFF é…ç½®
const LIFF_ID = '2007618883-ewZnj9Py'; // è«‹æ›¿æ›ç‚ºå¯¦éš›çš„ LIFF ID
let userProfile = null;
let isLiffReady = false;

// ç‹€æ…‹
let events = [];
let selectedEventIds = [];
let currentView = 'list';
let currentDate = new Date();

// å¾ URL ç²å–æ“šé»åƒæ•¸
const urlParams = new URLSearchParams(window.location.search);
const siteKeyword = urlParams.get('site') || '';

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    if (siteKeyword) {
        document.getElementById('siteInfo').classList.remove('hidden');
        document.getElementById('currentSite').textContent = siteKeyword;

        // é¡¯ç¤ºæ“šé»åç¨±å¤§æ¨™é¡Œ
        const siteTitleHeader = document.getElementById('siteTitleHeader');
        siteTitleHeader.textContent = siteKeyword;
        siteTitleHeader.classList.remove('hidden');
    }

    loadEvents();
    setupForm();
    updateViewButtons();
    
    // æ–°å¢ï¼šåˆå§‹åŒ– LIFF
    initializeLiff();
});

// è¼‰å…¥æ´»å‹•
async function loadEvents() {
    const container = document.getElementById('eventsContainer');
    container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

    try {
        const url = `${API_URL}?mode=events&site=${encodeURIComponent(siteKeyword)}`;
        console.log('è¼‰å…¥ URL:', url);

        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        console.log('æ”¶åˆ°è³‡æ–™:', data);

        if (data.error) {
            throw new Error(data.error);
        }

        events = Array.isArray(data) ? data : data.events || [];
        console.log('æ´»å‹•æ•¸é‡:', events.length);

        // æ ¹æ“šç•¶å‰æª¢è¦–æ¨¡å¼æ¸²æŸ“
        if (currentView === 'calendar') {
            renderCalendar();
        } else {
            renderEventsList();
        }

    } catch (error) {
        console.error('è¼‰å…¥éŒ¯èª¤:', error);
        container.innerHTML = `
            <div class="error">
                <h4>è¼‰å…¥å¤±æ•—</h4>
                <p>éŒ¯èª¤ï¼š${error.message}</p>
                <p>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦</p>
            </div>
        `;
    }
}

// åˆ‡æ›åˆ°æœˆæ›†æª¢è¦–
function switchToCalendar() {
    currentView = 'calendar';
    updateViewButtons();
    document.getElementById('listView').classList.add('hidden');
    document.getElementById('calendarView').classList.remove('hidden');
    renderCalendar();
}

// åˆ‡æ›åˆ°åˆ—è¡¨æª¢è¦–
function switchToList() {
    currentView = 'list';
    updateViewButtons();
    document.getElementById('calendarView').classList.add('hidden');
    document.getElementById('listView').classList.remove('hidden');
    renderEventsList();
}

// æ›´æ–°æª¢è¦–æŒ‰éˆ•ç‹€æ…‹
function updateViewButtons() {
    const calendarBtn = document.getElementById('calendarViewBtn');
    const listBtn = document.getElementById('listViewBtn');

    if (currentView === 'calendar') {
        calendarBtn.classList.add('btn-active');
        calendarBtn.classList.remove('btn-outline');
        listBtn.classList.add('btn-outline');
        listBtn.classList.remove('btn-active');
    } else {
        listBtn.classList.add('btn-active');
        listBtn.classList.remove('btn-outline');
        calendarBtn.classList.add('btn-outline');
        calendarBtn.classList.remove('btn-active');
    }
}

// æ¸²æŸ“æœˆæ›†
function renderCalendar() {
    const monthDisplay = document.getElementById('currentMonth');
    const calendarGrid = document.getElementById('calendarGrid');

    // è¨­å®šæœˆä»½é¡¯ç¤º
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    monthDisplay.textContent = `${year}å¹´ ${month + 1}æœˆ`;

    // æ¸…ç©ºç¾æœ‰å…§å®¹
    calendarGrid.innerHTML = '';

    // å»ºç«‹æ˜ŸæœŸæ¨™é¡Œ
    const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    weekdays.forEach(day => {
        const weekdayDiv = document.createElement('div');
        weekdayDiv.className = 'calendar-weekday';
        weekdayDiv.textContent = day;
        calendarGrid.appendChild(weekdayDiv);
    });

    // å–å¾—æœ¬æœˆç¬¬ä¸€å¤©å’Œæœ€å¾Œä¸€å¤©
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const firstDayWeekday = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    // å–å¾—ä¸Šå€‹æœˆçš„æœ€å¾Œå¹¾å¤©
    const prevMonth = new Date(year, month, 0);
    const daysInPrevMonth = prevMonth.getDate();

    // å¡«å…¥ä¸Šå€‹æœˆçš„æ—¥æœŸ
    for (let i = firstDayWeekday - 1; i >= 0; i--) {
        const dayDiv = createCalendarDay(daysInPrevMonth - i, true);
        calendarGrid.appendChild(dayDiv);
    }

    // å¡«å…¥æœ¬æœˆçš„æ—¥æœŸ
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = createCalendarDay(day, false);
        calendarGrid.appendChild(dayDiv);
    }

    // å¡«å…¥ä¸‹å€‹æœˆçš„æ—¥æœŸ
    const totalCells = calendarGrid.children.length - 7; // æ¸›å»æ˜ŸæœŸæ¨™é¡Œ
    const remainingCells = 42 - totalCells; // 6é€± * 7å¤© = 42æ ¼
    for (let day = 1; day <= remainingCells; day++) {
        const dayDiv = createCalendarDay(day, true);
        calendarGrid.appendChild(dayDiv);
    }
}

// å»ºç«‹æœˆæ›†æ—¥æœŸæ ¼å­
function createCalendarDay(dayNumber, isOtherMonth) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'calendar-day';

    if (isOtherMonth) {
        dayDiv.classList.add('other-month');
    }

    // æª¢æŸ¥æ˜¯å¦ç‚ºä»Šå¤©
    const today = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth();

    if (!isOtherMonth &&
        today.getDate() === dayNumber &&
        today.getMonth() === currentMonth &&
        today.getFullYear() === currentYear) {
        dayDiv.classList.add('today');
    }

    // å»ºç«‹æ—¥æœŸæ•¸å­—
    const dayNumberDiv = document.createElement('div');
    dayNumberDiv.className = 'day-number';
    dayNumberDiv.textContent = dayNumber;
    dayDiv.appendChild(dayNumberDiv);

    // å»ºç«‹æ´»å‹•åˆ—è¡¨
    const eventsDiv = document.createElement('div');
    eventsDiv.className = 'day-events';

    if (!isOtherMonth) {
        // å°‹æ‰¾è©²æ—¥çš„æ´»å‹•
        const dayEvents = findEventsForDate(currentYear, currentMonth, dayNumber);
        dayEvents.forEach(event => {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'calendar-event';
            
            // æª¢æŸ¥é¡æ»¿ç‹€æ…‹
            if (event.isFull) {
                eventDiv.classList.add('full');
            } else if (event.remainingSlots !== null && event.remainingSlots <= 3) {
                eventDiv.classList.add('warning');
            }
            
            if (selectedEventIds.includes(event['æ´»å‹•ID']) && !event.isFull) {
                eventDiv.classList.add('selected');
            }

            // é¡¯ç¤ºæ™‚é–“å’Œæ¨™é¡Œ
            const timeStr = formatTime(event['é–‹å§‹æ™‚é–“']);
            let displayText = `${timeStr} ${event['æ´»å‹•æ¨™é¡Œ']}`;
            
            // åŠ å…¥å®¹é‡è³‡è¨Š
            if (event['æ´»å‹•äººæ•¸ä¸Šé™'] && !isNaN(parseInt(event['æ´»å‹•äººæ•¸ä¸Šé™']))) {
                if (event.isFull) {
                    displayText += ' [é¡æ»¿]';
                } else if (event.remainingSlots <= 3) {
                    displayText += ` [å‰©${event.remainingSlots}]`;
                }
            }
            
            eventDiv.textContent = displayText;
            
            // è¨­å®šæç¤ºæ–‡å­— - ä¿®æ­£å ±åç‹€æ³é¡¯ç¤ºé‚è¼¯
            const currentCount = event.currentRegistrations || 0;
            let tooltipText = `${event['æ´»å‹•æ¨™é¡Œ']}\nè¬›å¸«ï¼š${event['è¬›å¸«'] || 'å¾…ç¢ºèª'}\næ™‚é–“ï¼š${timeStr}`;
            
            if (event['æ´»å‹•äººæ•¸ä¸Šé™'] && !isNaN(parseInt(event['æ´»å‹•äººæ•¸ä¸Šé™']))) {
                const maxCapacity = parseInt(event['æ´»å‹•äººæ•¸ä¸Šé™']);
                if (currentCount === 0) {
                    tooltipText += `\nå ±åï¼šå ±åä¸­/${maxCapacity}`;
                } else if (event.isFull) {
                    tooltipText += `\nå ±åï¼š${currentCount}/${maxCapacity} (å·²é¡æ»¿)`;
                } else if (event.remainingSlots <= 3) {
                    tooltipText += `\nå ±åï¼šå³å°‡é¡æ»¿/${maxCapacity}`;
                } else {
                    tooltipText += `\nå ±åï¼š${currentCount}/${maxCapacity}`;
                }
            } else {
                if (currentCount === 0) {
                    tooltipText += `\nå ±åï¼šå ±åä¸­`;
                } else {
                    tooltipText += `\nå ±åï¼š${currentCount}äººå·²å ±å`;
                }
            }
            
            eventDiv.title = tooltipText;

            eventDiv.onclick = (e) => {
                e.stopPropagation();
                if (!event.isFull) {
                    toggleEvent(event['æ´»å‹•ID']);
                } else {
                    alert(`å¾ˆæŠ±æ­‰ï¼Œã€Œ${event['æ´»å‹•æ¨™é¡Œ']}ã€å·²é¡æ»¿ï¼`);
                }
            };

            eventsDiv.appendChild(eventDiv);
        });
    }

    dayDiv.appendChild(eventsDiv);
    return dayDiv;
}

// å°‹æ‰¾ç‰¹å®šæ—¥æœŸçš„æ´»å‹•
function findEventsForDate(year, month, day) {
    const targetDate = new Date(year, month, day);
    return events.filter(event => {
        const eventDate = new Date(event['æ´»å‹•æ—¥æœŸ']);
        return eventDate.getFullYear() === year &&
               eventDate.getMonth() === month &&
               eventDate.getDate() === day;
    });
}

// æ”¹è®Šæœˆä»½
function changeMonth(direction) {
    currentDate.setMonth(currentDate.getMonth() + direction);
    renderCalendar();
}

// æ¸²æŸ“æ´»å‹•åˆ—è¡¨
function renderEventsList() {
    const container = document.getElementById('eventsContainer');

    if (events.length === 0) {
        container.innerHTML = `
            <div class="error">
                <h4>æ²’æœ‰æ‰¾åˆ°èª²ç¨‹</h4>
                <p>ç›®å‰æ²’æœ‰å¯å ±åçš„èª²ç¨‹</p>
            </div>
        `;
        return;
    }

    // æŒ‰æ—¥æœŸæ’åºæ´»å‹•
    const sortedEvents = [...events].sort((a, b) => {
        const dateA = new Date(a['æ´»å‹•æ—¥æœŸ']);
        const dateB = new Date(b['æ´»å‹•æ—¥æœŸ']);
        return dateA - dateB;
    });

    const html = sortedEvents.map(event => {
        const isFull = event.isFull;
        const hasLimit = event['æ´»å‹•äººæ•¸ä¸Šé™'] && !isNaN(parseInt(event['æ´»å‹•äººæ•¸ä¸Šé™']));
        const currentCount = event.currentRegistrations || 0;
        const isWarning = hasLimit && event.remainingSlots <= 3 && !isFull;
        
        let capacityInfo = '';
        if (hasLimit) {
            const maxCapacity = parseInt(event['æ´»å‹•äººæ•¸ä¸Šé™']);
            let displayText = '';
            
            if (currentCount === 0) {
                displayText = `å ±åä¸­/${maxCapacity}`;
            } else if (isFull) {
                displayText = `${currentCount}/${maxCapacity}`;
            } else if (isWarning) {
                displayText = `å³å°‡é¡æ»¿/${maxCapacity}`;
            } else {
                displayText = `${currentCount}/${maxCapacity}`;
            }
            
            const capacityClass = isFull ? 'capacity-full' : 
                                 isWarning ? 'capacity-warning' : 
                                 'capacity-available';
            capacityInfo = `<span class="capacity-info ${capacityClass}">${displayText}</span>`;
        }

        return `
            <div class="event-card ${isFull ? 'full' : ''} ${selectedEventIds.includes(event['æ´»å‹•ID']) && !isFull ? 'selected' : ''}" 
                 data-event-id="${event['æ´»å‹•ID']}" 
                 onclick="${isFull ? `alert('å¾ˆæŠ±æ­‰ï¼Œæ­¤æ´»å‹•å·²é¡æ»¿ï¼')` : `toggleEvent('${event['æ´»å‹•ID']}')`}">
                
                ${isFull ? '<div class="full-overlay">ğŸš« å·²é¡æ»¿</div>' : ''}
                
                <div class="event-header">
                    <input type="checkbox" class="event-checkbox" 
                           ${selectedEventIds.includes(event['æ´»å‹•ID']) && !isFull ? 'checked' : ''} 
                           ${isFull ? 'disabled' : ''}>
                    <h3 class="event-title ${isFull ? 'full' : ''}">${event['æ´»å‹•æ¨™é¡Œ']} ${capacityInfo}</h3>
                </div>
                <div class="event-details">
                    <div>ğŸ‘¨â€ğŸ« è¬›å¸«ï¼š${event['è¬›å¸«'] || 'å¾…ç¢ºèª'}</div>
                    <div>ğŸ“… æ—¥æœŸï¼š${formatDate(event['æ´»å‹•æ—¥æœŸ'])}</div>
                    <div>ğŸ• æ™‚é–“ï¼š${formatTime(event['é–‹å§‹æ™‚é–“'])}</div>
                    <div>ğŸ“ åœ°é»ï¼š${event['åœ°å€æˆ–åœ°é»èªªæ˜'] || 'å¾…ç¢ºèª'}</div>
                    ${hasLimit ? 
                        `<div>ğŸ‘¥ å ±åç‹€æ³ï¼š${currentCount === 0 ? 'å ±åä¸­' : 
                            isFull ? `${currentCount}/${event['æ´»å‹•äººæ•¸ä¸Šé™']} (å·²é¡æ»¿)` : 
                            isWarning ? `å³å°‡é¡æ»¿/${event['æ´»å‹•äººæ•¸ä¸Šé™']}` : 
                            `${currentCount}/${event['æ´»å‹•äººæ•¸ä¸Šé™']}`}</div>` : 
                        `<div>ğŸ‘¥ å ±åç‹€æ³ï¼š${currentCount === 0 ? 'å ±åä¸­' : `${currentCount}äººå·²å ±å`}</div>`
                    }
                    ${event['æ´»å‹•å…§å®¹'] ? `<div>ğŸ“‹ å…§å®¹ï¼š${event['æ´»å‹•å…§å®¹']}</div>` : ''}
                    ${event['å‚™è¨»'] ? `<div>âš ï¸ å‚™è¨»ï¼š${event['å‚™è¨»']}</div>` : ''}
                    ${event['è‡ªè¨‚æ¬„ä½å•é¡Œ'] ? `<div>â“ å•é¡Œï¼š${event['è‡ªè¨‚æ¬„ä½å•é¡Œ']}</div>` : ''}
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = `<div class="events-grid">${html}</div>`;
    updateEventCards();
}

// åˆ‡æ›æ´»å‹•é¸æ“‡
function toggleEvent(eventId) {
    // æª¢æŸ¥æ´»å‹•æ˜¯å¦é¡æ»¿
    const event = events.find(e => e['æ´»å‹•ID'] === eventId);
    if (event && event.isFull) {
        alert(`å¾ˆæŠ±æ­‰ï¼Œã€Œ${event['æ´»å‹•æ¨™é¡Œ']}ã€å·²é¡æ»¿ï¼`);
        return;
    }

    const index = selectedEventIds.indexOf(eventId);

    if (index > -1) {
        selectedEventIds.splice(index, 1);
    } else {
        selectedEventIds.push(eventId);
    }

    // æ›´æ–°é¡¯ç¤º
    if (currentView === 'calendar') {
        renderCalendar();
    } else {
        updateEventCards();
    }

    updateSelectedSummary();
    updateCustomFields();
}

// æ›´æ–°æ´»å‹•å¡ç‰‡é¸æ“‡ç‹€æ…‹
function updateEventCards() {
    document.querySelectorAll('.event-card').forEach(card => {
        const eventId = card.dataset.eventId;
        const checkbox = card.querySelector('.event-checkbox');
        const isSelected = selectedEventIds.includes(eventId);
        const event = events.find(e => e['æ´»å‹•ID'] === eventId);
        const isFull = event && event.isFull;

        if (isSelected && !isFull) {
            card.classList.add('selected');
            checkbox.checked = true;
        } else {
            card.classList.remove('selected');
            checkbox.checked = false;
        }
    });
}

// æ›´æ–°å·²é¸èª²ç¨‹æ‘˜è¦
function updateSelectedSummary() {
    const summaryDiv = document.getElementById('selectedSummary');
    const listDiv = document.getElementById('selectedList');

    if (selectedEventIds.length === 0) {
        summaryDiv.classList.add('hidden');
        return;
    }

    const selectedEvents = events.filter(event =>
        selectedEventIds.includes(event['æ´»å‹•ID'])
    );

    const html = selectedEvents.map(event => {
        const currentCount = event.currentRegistrations || 0;
        let capacityText = '';
        
        if (event['æ´»å‹•äººæ•¸ä¸Šé™'] && !isNaN(parseInt(event['æ´»å‹•äººæ•¸ä¸Šé™']))) {
            const maxCapacity = parseInt(event['æ´»å‹•äººæ•¸ä¸Šé™']);
            if (currentCount === 0) {
                capacityText = ` (å ±åä¸­/${maxCapacity})`;
            } else {
                capacityText = ` (${currentCount}/${maxCapacity})`;
            }
        } else {
            if (currentCount === 0) {
                capacityText = ' (å ±åä¸­)';
            } else {
                capacityText = ` (${currentCount}äººå·²å ±å)`;
            }
        }
        
        return `
            <div style="margin-bottom: 8px; padding: 8px; background: #f0f9ff; border-radius: 4px;">
                <strong>${event['æ´»å‹•æ¨™é¡Œ']}</strong>${capacityText}<br>
                <small>ğŸ“… ${formatDate(event['æ´»å‹•æ—¥æœŸ'])} ğŸ• ${formatTime(event['é–‹å§‹æ™‚é–“'])}</small>
            </div>
        `;
    }).join('');

    listDiv.innerHTML = html;
    summaryDiv.classList.remove('hidden');
}

// æ›´æ–°è‡ªè¨‚æ¬„ä½
function updateCustomFields() {
    const customFieldsDiv = document.getElementById('customFields');
    const selectedEvents = events.filter(event =>
        selectedEventIds.includes(event['æ´»å‹•ID'])
    );

    // æ‰¾å‡ºæœ‰è‡ªè¨‚å•é¡Œçš„æ´»å‹•
    const eventsWithCustomFields = selectedEvents.filter(event =>
        event['è‡ªè¨‚æ¬„ä½å•é¡Œ'] && event['è‡ªè¨‚æ¬„ä½å•é¡Œ'].trim()
    );

    if (eventsWithCustomFields.length === 0) {
        customFieldsDiv.classList.add('hidden');
        customFieldsDiv.innerHTML = '';
        return;
    }

    let html = '<div class="custom-fields"><h4>ğŸ“‹ èª²ç¨‹ç›¸é—œå•é¡Œ</h4>';

    eventsWithCustomFields.forEach(event => {
        html += `
            <div class="form-group">
                <label class="form-label">${event['æ´»å‹•æ¨™é¡Œ']} - ${event['è‡ªè¨‚æ¬„ä½å•é¡Œ']}</label>
                <textarea class="form-control" name="custom_${event['æ´»å‹•ID']}" rows="2"
                          placeholder="è«‹å›ç­”æ­¤å•é¡Œ..."></textarea>
            </div>
        `;
    });

    html += '</div>';
    customFieldsDiv.innerHTML = html;
    customFieldsDiv.classList.remove('hidden');
}

// æ¸…é™¤é¸æ“‡
function clearSelection() {
    selectedEventIds = [];

    if (currentView === 'calendar') {
        renderCalendar();
    } else {
        updateEventCards();
    }

    updateSelectedSummary();
    updateCustomFields();
}

// è¨­ç½®è¡¨å–®
function setupForm() {
    document.getElementById('signupForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        if (selectedEventIds.length === 0) {
            alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹èª²ç¨‹');
            return;
        }

        // æª¢æŸ¥é¸æ“‡çš„èª²ç¨‹æ˜¯å¦æœ‰é¡æ»¿çš„
        const selectedEvents = events.filter(event => selectedEventIds.includes(event['æ´»å‹•ID']));
        const fullEvents = selectedEvents.filter(event => event.isFull);
        
        if (fullEvents.length > 0) {
            alert(`å¾ˆæŠ±æ­‰ï¼Œä»¥ä¸‹èª²ç¨‹å·²é¡æ»¿ï¼Œè«‹é‡æ–°é¸æ“‡ï¼š\n${fullEvents.map(e => e['æ´»å‹•æ¨™é¡Œ']).join('\n')}`);
            return;
        }

        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');

        submitBtn.disabled = true;
        submitBtn.textContent = 'å ±åä¸­...';

        let successCount = 0;
        let errorMessages = [];

        try {
            for (const eventId of selectedEventIds) {
                // æ”¶é›†è‡ªè¨‚æ¬„ä½å›ç­”
                const customAnswer = formData.get(`custom_${eventId}`) || '';

                // å–å¾— LINE IDï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                const lineId = document.getElementById('lineIdField')?.value || '';

                const data = new URLSearchParams({
                    action: 'register',
                    eventId: eventId,
                    name: formData.get('name'),
                    lineName: formData.get('lineName'),
                    lineId: lineId, // æ–°å¢ï¼šå‚³é€ LINE ID
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    gender: formData.get('gender'),
                    age: formData.get('age'),
                    note: formData.get('note'),
                    customFieldAnswer: customAnswer
                });

                // è¨˜éŒ„æäº¤è³‡æ–™ï¼ˆé™¤éŒ¯ç”¨ï¼‰
                console.log('ğŸ“¤ æäº¤è³‡æ–™åŒ…å« LINE ID:', {
                    name: formData.get('name'),
                    lineId: lineId ? 'æœ‰' : 'ç„¡',
                    isLiff: isLiffReady
                });

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: data
                });

                const result = await response.json();

                if (result.error || !result.success) {
                    const event = events.find(e => e['æ´»å‹•ID'] === eventId);
                    const eventTitle = event ? event['æ´»å‹•æ¨™é¡Œ'] : eventId;
                    errorMessages.push(`${eventTitle}: ${result.error || 'æœªçŸ¥éŒ¯èª¤'}`);
                } else {
                    successCount++;
                }
            }

            // é‡æ–°è¼‰å…¥æ´»å‹•è³‡æ–™ä»¥æ›´æ–°å®¹é‡ç‹€æ…‹
            await loadEvents();

            if (successCount > 0) {
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                const successMsg = document.createElement('div');
                successMsg.className = 'success';
                successMsg.innerHTML = `
                    <h4>ğŸ‰ å ±åæˆåŠŸï¼</h4>
                    <p>æ‚¨å·²æˆåŠŸå ±å ${successCount} å€‹èª²ç¨‹</p>
                    ${errorMessages.length > 0 ? `<p style="color: #ff9800;">éƒ¨åˆ†èª²ç¨‹å ±åå¤±æ•—ï¼š<br>${errorMessages.join('<br>')}</p>` : ''}
                    <p>æˆ‘å€‘æœƒåœ¨æ´»å‹•å‰ä¸€å¤©æé†’æ‚¨ï¼Œè«‹æº–æ™‚åƒåŠ ï¼</p>
                `;

                this.parentNode.insertBefore(successMsg, this);

                // æ¸…é™¤è¡¨å–®å’Œé¸æ“‡
                this.reset();
                clearSelection();

                // 5ç§’å¾Œç§»é™¤æˆåŠŸè¨Šæ¯
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.parentNode.removeChild(successMsg);
                    }
                }, 5000);
            } else {
                throw new Error(errorMessages.join('\n'));
            }

        } catch (error) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'error';
            errorMsg.innerHTML = `
                <h4>âŒ å ±åå¤±æ•—</h4>
                <p>${error.message}</p>
            `;
            this.parentNode.insertBefore(errorMsg, this);

            setTimeout(() => {
                if (errorMsg.parentNode) {
                    errorMsg.parentNode.removeChild(errorMsg);
                }
            }, 5000);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'âœ… é€å‡ºå ±å';
        }
    });
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
        const date = new Date(dateStr);
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const weekday = weekdays[date.getDay()];
        return `${month}/${day} (${weekday})`;
    } catch {
        return dateStr;
    }
}

// æ ¼å¼åŒ–æ™‚é–“
function formatTime(timeStr) {
    if (!timeStr) return '';
    try {
        if (timeStr.toString().includes('1899')) {
            const date = new Date(timeStr);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        return timeStr;
    } catch {
        return timeStr;
    }
}

// éµç›¤å¿«æ·éµ
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + L: åˆ‡æ›åˆ°åˆ—è¡¨æª¢è¦–
    if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
        e.preventDefault();
        switchToList();
    }

    // Ctrl/Cmd + C: åˆ‡æ›åˆ°æœˆæ›†æª¢è¦–
    if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        e.preventDefault();
        switchToCalendar();
    }

    // Escape: æ¸…é™¤é¸æ“‡
    if (e.key === 'Escape') {
        clearSelection();
    }
});

// è§¸æ§æ‰‹å‹¢æ”¯æ´ï¼ˆæ‰‹æ©Ÿæ»‘å‹•åˆ‡æ›æœˆä»½ï¼‰
let touchStartX = 0;
let touchEndX = 0;

document.getElementById('calendarView').addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
});

document.getElementById('calendarView').addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    const swipeThreshold = 50;
    const swipeDistance = touchEndX - touchStartX;

    if (Math.abs(swipeDistance) > swipeThreshold) {
        if (swipeDistance > 0) {
            // å‘å³æ»‘å‹• - ä¸Šå€‹æœˆ
            changeMonth(-1);
        } else {
            // å‘å·¦æ»‘å‹• - ä¸‹å€‹æœˆ
            changeMonth(1);
        }
    }
}

// é é¢å¯è¦‹æ€§è®Šæ›´æ™‚é‡æ–°è¼‰å…¥ï¼ˆé¿å…è³‡æ–™éæœŸï¼‰
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        // å¦‚æœè¶…é5åˆ†é˜æ²’æœ‰é‡æ–°è¼‰å…¥ï¼Œè‡ªå‹•é‡æ–°è¼‰å…¥
        const lastLoad = localStorage.getItem('lastEventLoad');
        const now = Date.now();
        if (!lastLoad || (now - parseInt(lastLoad)) > 5 * 60 * 1000) {
            loadEvents();
            localStorage.setItem('lastEventLoad', now.toString());
        }
    }
});

// è¨­å®šåˆå§‹è¼‰å…¥æ™‚é–“
localStorage.setItem('lastEventLoad', Date.now().toString());

/**
 * LIFF ç›¸é—œå‡½å¼
 */
async function initializeLiff() {
    try {
        console.log('ğŸ”„ æª¢æŸ¥ LIFF ç’°å¢ƒ...');
        
        if (typeof liff === 'undefined') {
            console.log('âš ï¸ ä¸åœ¨ LIFF ç’°å¢ƒä¸­ï¼Œä½¿ç”¨ä¸€èˆ¬æ¨¡å¼');
            return;
        }
        
        await liff.init({ liffId: LIFF_ID });
        
        if (liff.isLoggedIn()) {
            console.log('âœ… LIFF ç™»å…¥æˆåŠŸ');
            await getUserProfile();
            isLiffReady = true;
            showLiffStatus();
        } else {
            console.log('âŒ LIFF æœªç™»å…¥ï¼Œå˜—è©¦ç™»å…¥...');
            liff.login();
        }
        
    } catch (error) {
        console.error('âŒ LIFF åˆå§‹åŒ–å¤±æ•—:', error);
    }
}

async function getUserProfile() {
    try {
        userProfile = await liff.getProfile();
        console.log('ğŸ‘¤ LIFF ä½¿ç”¨è€…è³‡æ–™:', userProfile);
        
        const lineNameField = document.querySelector('input[name="lineName"]');
        const lineIdField = document.getElementById('lineIdField');
        
        if (lineNameField && userProfile.displayName) {
            lineNameField.value = userProfile.displayName;
            lineNameField.readOnly = true;
        }
        
        if (lineIdField && userProfile.userId) {
            lineIdField.value = userProfile.userId;
        }
        
        console.log('âœ… LIFF ä½¿ç”¨è€…è³‡æ–™å·²è‡ªå‹•å¡«å…¥');
        
    } catch (error) {
        console.error('âŒ å–å¾— LIFF ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:', error);
    }
}

function showLiffStatus() {
    const header = document.querySelector('.header p');
    if (header && userProfile) {
        header.innerHTML = `é¸æ“‡æ‚¨æƒ³åƒåŠ çš„èª²ç¨‹<br><small style="color: rgba(255,255,255,0.8);">ğŸ‘‹ æ­¡è¿ï¼Œ${userProfile.displayName}ï¼</small>`;
    }
}
</script>
</body>
</html>
