<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>課程報名系統</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: #f5f5f5;
    color: #333;
    line-height: 1.6;
    font-size: 16px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    background: #ff9800;
    color: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
    text-align: center;
}

.header h1 {
    font-size: 28px;
    margin-bottom: 10px;
}

.site-info {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #2196f3;
}

.view-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.2s;
    min-height: 44px;
}

.btn-primary {
    background: #ff9800;
    color: white;
}

.btn-primary:hover {
    background: #f57c00;
}

.btn-outline {
    background: white;
    color: #ff9800;
    border: 2px solid #ff9800;
}

.btn-outline:hover {
    background: #ff9800;
    color: white;
}

.btn-active {
    background: #f57c00;
    color: white;
}

/* 月曆樣式 */
.calendar-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 30px;
}

.calendar-header {
    background: #ff9800;
    color: white;
    padding: 20px;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.month-nav {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 4px;
    transition: background 0.2s;
}

.month-nav:hover {
    background: rgba(255, 255, 255, 0.1);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
}

.calendar-weekday {
    background: #fff3e0;
    padding: 15px 8px;
    text-align: center;
    font-weight: bold;
    color: #f57c00;
    border-bottom: 1px solid #ffe0b2;
}

.calendar-day {
    min-height: 120px;
    border: 1px solid #f0f0f0;
    padding: 8px;
    position: relative;
    background: white;
}

.calendar-day.other-month {
    background: #fafafa;
    color: #999;
}

.calendar-day.today {
    background: #fff3e0;
    border-color: #ff9800;
}

.day-number {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 4px;
    color: #666;
}

.day-events {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.calendar-event {
    background: #ff9800;
    color: white;
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 12px;
    line-height: 1.2;
    cursor: pointer;
    transition: all 0.2s;
}

.calendar-event:hover {
    background: #f57c00;
    transform: translateY(-1px);
}

.calendar-event.selected {
    background: #4caf50;
    box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
}

/* 列表樣式 */
.events-grid {
    display: grid;
    gap: 20px;
}

.event-card {
    background: white;
    border: 2px solid #ddd;
    border-radius: 12px;
    padding: 24px;
    cursor: pointer;
    transition: all 0.2s;
}

.event-card:hover {
    border-color: #ff9800;
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.15);
}

.event-card.selected {
    border-color: #4caf50;
    background: #f1f8e9;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
}

.event-header {
    display: flex;
    align-items: flex-start;
    margin-bottom: 15px;
}

.event-checkbox {
    width: 20px;
    height: 20px;
    margin-right: 15px;
    margin-top: 2px;
    flex-shrink: 0;
}

.event-title {
    font-size: 20px;
    font-weight: 600;
    color: #ff9800;
    margin: 0;
    line-height: 1.3;
}

.event-details {
    color: #666;
    font-size: 16px;
    line-height: 1.5;
}

.event-details div {
    margin-bottom: 8px;
}

/* 表單樣式 */
.form-section {
    background: white;
    padding: 30px;
    border-radius: 12px;
    margin-top: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
    font-size: 16px;
}

.required {
    color: #f44336;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: #ff9800;
    box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
}

.custom-fields {
    background: #fff3e0;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
    border-left: 4px solid #ff9800;
}

.custom-fields h4 {
    color: #f57c00;
    margin-bottom: 15px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 18px;
}

.error {
    background: #ffebee;
    color: #c62828;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #f44336;
    font-size: 16px;
}

.success {
    background: #e8f5e8;
    color: #2e7d32;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #4caf50;
}

.hidden {
    display: none;
}

/* 響應式設計 */
@media (max-width: 768px) {
    .container {
        padding: 15px;
    }

    .header h1 {
        font-size: 24px;
    }

    .view-toggle {
        flex-direction: column;
    }

    .calendar-header {
        font-size: 20px;
        padding: 15px;
    }

    .calendar-day {
        min-height: 80px;
        padding: 4px;
    }

    .calendar-event {
        font-size: 10px;
        padding: 2px 4px;
    }

    .event-card {
        padding: 20px;
    }

    .event-title {
        font-size: 18px;
    }

    .form-control {
        font-size: 16px; /* 防止 iOS 縮放 */
    }
}

@media (max-width: 480px) {
    .calendar-weekday {
        padding: 8px 4px;
        font-size: 14px;
    }

    .calendar-day {
        min-height: 60px;
        padding: 2px;
    }

    .day-number {
        font-size: 12px;
    }

    .calendar-event {
        font-size: 9px;
        padding: 1px 2px;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>🍊 課程報名系統</h1>
        <p>選擇您想參加的課程</p>
    </div>

    <div id="siteInfo" class="site-info hidden">
        <strong>📍 當前據點：</strong><span id="currentSite"></span>
    </div>

    <div class="view-toggle">
        <button class="btn btn-primary" onclick="loadEvents()">🔄 重新載入</button>
        <button class="btn btn-outline" id="calendarViewBtn" onclick="switchToCalendar()">📅 月曆檢視</button>
        <button class="btn btn-outline" id="listViewBtn" onclick="switchToList()">📋 列表檢視</button>
        <button class="btn btn-outline" onclick="clearSelection()">🗑️ 清除選擇</button>
    </div>

    <!-- 月曆檢視 -->
    <div id="calendarView" class="calendar-container hidden">
        <div class="calendar-header">
            <button class="month-nav" onclick="changeMonth(-1)">‹</button>
            <span id="currentMonth"></span>
            <button class="month-nav" onclick="changeMonth(1)">›</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <!-- 列表檢視 -->
    <div id="listView">
        <div id="eventsContainer">
            <div class="loading">載入中...</div>
        </div>
    </div>

    <!-- 已選課程摘要 -->
    <div id="selectedSummary" class="hidden" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
        <h3 style="color: #4caf50; margin-bottom: 10px;">✅ 已選擇的課程</h3>
        <div id="selectedList"></div>
    </div>

    <div class="form-section">
        <h3 style="margin-bottom: 20px; color: #ff9800;">📝 報名資料</h3>
        <form id="signupForm">
            <div class="form-group">
                <label class="form-label">姓名 <span class="required">*</span></label>
                <input type="text" class="form-control" name="name" required placeholder="請輸入您的姓名">
            </div>

            <div class="form-group">
                <label class="form-label">LINE名稱 <span class="required">*</span></label>
                <input type="text" class="form-control" name="lineName" required placeholder="請輸入您在LINE上顯示的名稱">
            </div>

            <div class="form-group">
                <label class="form-label">手機號碼 <span class="required">*</span></label>
                <input type="tel" class="form-control" name="phone" required placeholder="例如：0912345678">
            </div>

            <div class="form-group">
                <label class="form-label">電子郵件</label>
                <input type="email" class="form-control" name="email" placeholder="例如：example@gmail.com">
            </div>

            <div class="form-group">
                <label class="form-label">性別</label>
                <select class="form-control" name="gender">
                    <option value="">請選擇</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                    <option value="其他">其他</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">年齡</label>
                <input type="number" class="form-control" name="age" min="1" max="120" placeholder="請輸入您的年齡">
            </div>

            <div class="form-group">
                <label class="form-label">備註</label>
                <textarea class="form-control" name="note" rows="3" placeholder="如有特殊需求或想要補充的資訊，請在此填寫"></textarea>
            </div>

            <!-- 自訂欄位區域 -->
            <div id="customFields" class="hidden"></div>

            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 18px;">
                ✅ 送出報名
            </button>
        </form>
    </div>
</div>

<script>
    // 配置
    const API_URL = 'https://script.google.com/macros/s/AKfycbxpDCRA2PJXLy8ssWwG3NO4QZzg87gmUdB1vHWjYNdf9jmz-ku0yfnovhtfz58ep0oE/exec';

    // 狀態
    let events = [];
    let selectedEventIds = [];
    let currentView = 'list'; // 'list' 或 'calendar'
    let currentDate = new Date();

    // 從 URL 獲取據點參數
    const urlParams = new URLSearchParams(window.location.search);
    const siteKeyword = urlParams.get('site') || '';

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        if (siteKeyword) {
            document.getElementById('siteInfo').classList.remove('hidden');
            document.getElementById('currentSite').textContent = siteKeyword;
        }

        loadEvents();
        setupForm();
        updateViewButtons();
    });

    // 載入活動
    async function loadEvents() {
        const container = document.getElementById('eventsContainer');
        container.innerHTML = '<div class="loading">載入中...</div>';

        try {
            const url = `${API_URL}?mode=events&site=${encodeURIComponent(siteKeyword)}`;
            console.log('載入 URL:', url);

            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            console.log('收到資料:', data);

            if (data.error) {
                throw new Error(data.error);
            }

            events = Array.isArray(data) ? data : data.events || [];
            console.log('活動數量:', events.length);

            // 根據當前檢視模式渲染
            if (currentView === 'calendar') {
                renderCalendar();
            } else {
                renderEventsList();
            }

        } catch (error) {
            console.error('載入錯誤:', error);
            container.innerHTML = `
                <div class="error">
                    <h4>載入失敗</h4>
                    <p>錯誤：${error.message}</p>
                    <p>請檢查網路連線或稍後再試</p>
                    <button class="btn btn-primary" onclick="loadEvents()">重新載入</button>
                </div>
            `;
        }
    }

    // 切換到月曆檢視
    function switchToCalendar() {
        currentView = 'calendar';
        updateViewButtons();
        document.getElementById('listView').classList.add('hidden');
        document.getElementById('calendarView').classList.remove('hidden');
        renderCalendar();
    }

    // 切換到列表檢視
    function switchToList() {
        currentView = 'list';
        updateViewButtons();
        document.getElementById('calendarView').classList.add('hidden');
        document.getElementById('listView').classList.remove('hidden');
        renderEventsList();
    }

    // 更新檢視按鈕狀態
    function updateViewButtons() {
        const calendarBtn = document.getElementById('calendarViewBtn');
        const listBtn = document.getElementById('listViewBtn');
        
        if (currentView === 'calendar') {
            calendarBtn.classList.add('btn-active');
            calendarBtn.classList.remove('btn-outline');
            listBtn.classList.add('btn-outline');
            listBtn.classList.remove('btn-active');
        } else {
            listBtn.classList.add('btn-active');
            listBtn.classList.remove('btn-outline');
            calendarBtn.classList.add('btn-outline');
            calendarBtn.classList.remove('btn-active');
        }
    }

    // 渲染月曆
    function renderCalendar() {
        const monthDisplay = document.getElementById('currentMonth');
        const calendarGrid = document.getElementById('calendarGrid');
        
        // 設定月份顯示
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        monthDisplay.textContent = `${year}年 ${month + 1}月`;

        // 清空現有內容
        calendarGrid.innerHTML = '';

        // 建立星期標題
        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
        weekdays.forEach(day => {
            const weekdayDiv = document.createElement('div');
            weekdayDiv.className = 'calendar-weekday';
            weekdayDiv.textContent = day;
            calendarGrid.appendChild(weekdayDiv);
        });

        // 取得本月第一天和最後一天
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const firstDayWeekday = firstDay.getDay();
        const daysInMonth = lastDay.getDate();

        // 取得上個月的最後幾天
        const prevMonth = new Date(year, month, 0);
        const daysInPrevMonth = prevMonth.getDate();

        // 填入上個月的日期
        for (let i = firstDayWeekday - 1; i >= 0; i--) {
            const dayDiv = createCalendarDay(daysInPrevMonth - i, true);
            calendarGrid.appendChild(dayDiv);
        }

        // 填入本月的日期
        for (let day = 1; day <= daysInMonth; day++) {
            const dayDiv = createCalendarDay(day, false);
            calendarGrid.appendChild(dayDiv);
        }

        // 填入下個月的日期
        const totalCells = calendarGrid.children.length - 7; // 減去星期標題
        const remainingCells = 42 - totalCells; // 6週 * 7天 = 42格
        for (let day = 1; day <= remainingCells; day++) {
            const dayDiv = createCalendarDay(day, true);
            calendarGrid.appendChild(dayDiv);
        }
    }

    // 建立月曆日期格子
    function createCalendarDay(dayNumber, isOtherMonth) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        if (isOtherMonth) {
            dayDiv.classList.add('other-month');
        }

        // 檢查是否為今天
        const today = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth();
        
        if (!isOtherMonth && 
            today.getDate() === dayNumber && 
            today.getMonth() === currentMonth && 
            today.getFullYear() === currentYear) {
            dayDiv.classList.add('today');
        }

        // 建立日期數字
        const dayNumberDiv = document.createElement('div');
        dayNumberDiv.className = 'day-number';
        dayNumberDiv.textContent = dayNumber;
        dayDiv.appendChild(dayNumberDiv);

        // 建立活動列表
        const eventsDiv = document.createElement('div');
        eventsDiv.className = 'day-events';
        
        if (!isOtherMonth) {
            // 尋找該日的活動
            const dayEvents = findEventsForDate(currentYear, currentMonth, dayNumber);
            dayEvents.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'calendar-event';
                if (selectedEventIds.includes(event['活動ID'])) {
                    eventDiv.classList.add('selected');
                }
                
                // 顯示時間和標題
                const timeStr = formatTime(event['開始時間']);
                eventDiv.textContent = `${timeStr} ${event['活動標題']}`;
                eventDiv.title = `${event['活動標題']}\n講師：${event['講師'] || '待確認'}\n時間：${timeStr}`;
                
                eventDiv.onclick = (e) => {
                    e.stopPropagation();
                    toggleEvent(event['活動ID']);
                };
                
                eventsDiv.appendChild(eventDiv);
            });
        }
        
        dayDiv.appendChild(eventsDiv);
        return dayDiv;
    }

    // 尋找特定日期的活動
    function findEventsForDate(year, month, day) {
        const targetDate = new Date(year, month, day);
        return events.filter(event => {
            const eventDate = new Date(event['活動日期']);
            return eventDate.getFullYear() === year &&
                   eventDate.getMonth() === month &&
                   eventDate.getDate() === day;
        });
    }

    // 改變月份
    function changeMonth(direction) {
        currentDate.setMonth(currentDate.getMonth() + direction);
        renderCalendar();
    }

    // 渲染活動列表
    function renderEventsList() {
        const container = document.getElementById('eventsContainer');

        if (events.length === 0) {
            container.innerHTML = `
                <div class="error">
                    <h4>沒有找到課程</h4>
                    <p>目前沒有可報名的課程</p>
                </div>
            `;
            return;
        }

        // 按日期排序活動
        const sortedEvents = [...events].sort((a, b) => {
            const dateA = new Date(a['活動日期']);
            const dateB = new Date(b['活動日期']);
            return dateA - dateB;
        });

        const html = sortedEvents.map(event => `
            <div class="event-card" data-event-id="${event['活動ID']}" onclick="toggleEvent('${event['活動ID']}')">
                <div class="event-header">
                    <input type="checkbox" class="event-checkbox" ${selectedEventIds.includes(event['活動ID']) ? 'checked' : ''}>
                    <h3 class="event-title">${event['活動標題']}</h3>
                </div>
                <div class="event-details">
                    <div>👨‍🏫 講師：${event['講師'] || '待確認'}</div>
                    <div>📅 日期：${formatDate(event['活動日期'])}</div>
                    <div>🕐 時間：${formatTime(event['開始時間'])}</div>
                    <div>📍 地點：${event['地址或地點說明'] || '待確認'}</div>
                    ${event['活動內容'] ? `<div>📋 內容：${event['活動內容']}</div>` : ''}
                    ${event['備註'] ? `<div>⚠️ 備註：${event['備註']}</div>` : ''}
                    ${event['自訂欄位問題'] ? `<div>❓ 問題：${event['自訂欄位問題']}</div>` : ''}
                </div>
            </div>
        `).join('');

        container.innerHTML = `<div class="events-grid">${html}</div>`;
        updateEventCards();
    }

    // 切換活動選擇
    function toggleEvent(eventId) {
        const index = selectedEventIds.indexOf(eventId);
        
        if (index > -1) {
            selectedEventIds.splice(index, 1);
        } else {
            selectedEventIds.push(eventId);
        }

        // 更新顯示
        if (currentView === 'calendar') {
            renderCalendar();
        } else {
            updateEventCards();
        }
        
        updateSelectedSummary();
        updateCustomFields();
    }

    // 更新活動卡片選擇狀態
    function updateEventCards() {
        document.querySelectorAll('.event-card').forEach(card => {
            const eventId = card.dataset.eventId;
            const checkbox = card.querySelector('.event-checkbox');
            const isSelected = selectedEventIds.includes(eventId);
            
            if (isSelected) {
                card.classList.add('selected');
                checkbox.checked = true;
            } else {
                card.classList.remove('selected');
                checkbox.checked = false;
            }
        });
    }

    // 更新已選課程摘要
    function updateSelectedSummary() {
        const summaryDiv = document.getElementById('selectedSummary');
        const listDiv = document.getElementById('selectedList');
        
        if (selectedEventIds.length === 0) {
            summaryDiv.classList.add('hidden');
            return;
        }
        
        const selectedEvents = events.filter(event => 
            selectedEventIds.includes(event['活動ID'])
        );
        
        const html = selectedEvents.map(event => `
            <div style="margin-bottom: 8px; padding: 8px; background: #f0f9ff; border-radius: 4px;">
                <strong>${event['活動標題']}</strong><br>
                <small>📅 ${formatDate(event['活動日期'])} 🕐 ${formatTime(event['開始時間'])}</small>
            </div>
        `).join('');
        
        listDiv.innerHTML = html;
        summaryDiv.classList.remove('hidden');
    }

    // 更新自訂欄位
    function updateCustomFields() {
        const customFieldsDiv = document.getElementById('customFields');
        const selectedEvents = events.filter(event => 
            selectedEventIds.includes(event['活動ID'])
        );
        
        // 找出有自訂問題的活動
        const eventsWithCustomFields = selectedEvents.filter(event => 
            event['自訂欄位問題'] && event['自訂欄位問題'].trim()
        );
        
        if (eventsWithCustomFields.length === 0) {
            customFieldsDiv.classList.add('hidden');
            customFieldsDiv.innerHTML = '';
            return;
        }
        
        let html = '<div class="custom-fields"><h4>📋 課程相關問題</h4>';
        
        eventsWithCustomFields.forEach(event => {
            html += `
                <div class="form-group">
                    <label class="form-label">${event['活動標題']} - ${event['自訂欄位問題']}</label>
                    <textarea class="form-control" name="custom_${event['活動ID']}" rows="2" 
                              placeholder="請回答此問題..."></textarea>
                </div>
            `;
        });
        
        html += '</div>';
        customFieldsDiv.innerHTML = html;
        customFieldsDiv.classList.remove('hidden');
    }

    // 清除選擇
    function clearSelection() {
        selectedEventIds = [];
        
        if (currentView === 'calendar') {
            renderCalendar();
        } else {
            updateEventCards();
        }
        
        updateSelectedSummary();
        updateCustomFields();
    }

    // 設置表單
    function setupForm() {
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (selectedEventIds.length === 0) {
                alert('請至少選擇一個課程');
                return;
            }

            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');

            submitBtn.disabled = true;
            submitBtn.textContent = '報名中...';

            try {
                for (const eventId of selectedEventIds) {
                    // 收集自訂欄位回答
                    const customAnswer = formData.get(`custom_${eventId}`) || '';

                    const data = new URLSearchParams({
                        action: 'register',
                        eventId: eventId,
                        name: formData.get('name'),
                        lineName: formData.get('lineName'),
                        phone: formData.get('phone'),
                        email: formData.get('email'),
                        gender: formData.get('gender'),
                        age: formData.get('age'),
                        note: formData.get('note'),
                        customFieldAnswer: customAnswer
                    });

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: data
                    });

                    const result = await response.json();

                    if (result.error) {
                        throw new Error(result.error);
                    }
                }

                // 顯示成功訊息
                const successMsg = document.createElement('div');
                successMsg.className = 'success';
                successMsg.innerHTML = `
                    <h4>🎉 報名成功！</h4>
                    <p>您已成功報名 ${selectedEventIds.length} 個課程</p>
                    <p>我們會在活動前一天提醒您，請準時參加！</p>
                `;
                
                this.parentNode.insertBefore(successMsg, this);
                
                // 清除表單和選擇
                this.reset();
                clearSelection();
                
                // 3秒後移除成功訊息
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.parentNode.removeChild(successMsg);
                    }
                }, 5000);

            } catch (error) {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error';
                errorMsg.innerHTML = `
                    <h4>❌ 報名失敗</h4>
                    <p>${error.message}</p>
                `;
                this.parentNode.insertBefore(errorMsg, this);
                
                setTimeout(() => {
                    if (errorMsg.parentNode) {
                        errorMsg.parentNode.removeChild(errorMsg);
                    }
                }, 5000);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '✅ 送出報名';
            }
        });
    }

    // 格式化日期
    function formatDate(dateStr) {
        if (!dateStr) return '';
        try {
            const date = new Date(dateStr);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            const weekday = weekdays[date.getDay()];
            return `${month}/${day} (${weekday})`;
        } catch {
            return dateStr;
        }
    }

    // 格式化時間
    function formatTime(timeStr) {
        if (!timeStr) return '';
        try {
            if (timeStr.toString().includes('1899')) {
                const date = new Date(timeStr);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            }
            return timeStr;
        } catch {
            return timeStr;
        }
    }

    // 鍵盤快捷鍵
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + L: 切換到列表檢視
        if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
            e.preventDefault();
            switchToList();
        }
        
        // Ctrl/Cmd + C: 切換到月曆檢視
        if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
            e.preventDefault();
            switchToCalendar();
        }
        
        // Escape: 清除選擇
        if (e.key === 'Escape') {
            clearSelection();
        }
    });

    // 觸控手勢支援（手機滑動切換月份）
    let touchStartX = 0;
    let touchEndX = 0;

    document.getElementById('calendarView').addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
    });

    document.getElementById('calendarView').addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });

    function handleSwipe() {
        const swipeThreshold = 50;
        const swipeDistance = touchEndX - touchStartX;
        
        if (Math.abs(swipeDistance) > swipeThreshold) {
            if (swipeDistance > 0) {
                // 向右滑動 - 上個月
                changeMonth(-1);
            } else {
                // 向左滑動 - 下個月
                changeMonth(1);
            }
        }
    }

    // 頁面可見性變更時重新載入（避免資料過期）
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            // 如果超過5分鐘沒有重新載入，自動重新載入
            const lastLoad = localStorage.getItem('lastEventLoad');
            const now = Date.now();
            if (!lastLoad || (now - parseInt(lastLoad)) > 5 * 60 * 1000) {
                loadEvents();
                localStorage.setItem('lastEventLoad', now.toString());
            }
        }
    });

    // 設定初始載入時間
    localStorage.setItem('lastEventLoad', Date.now().toString());
</script>
</body>
</html>
