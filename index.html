<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÊûúÂ§öÊ¥ªÂãïÂ†±ÂêçÁ≥ªÁµ±</title>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: #f5f5f5;
    color: #333;
    line-height: 1.6;
    font-size: 18px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.site-title {
    background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    color: white;
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 20px;
    text-align: center;
    font-size: 32px;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
}

.header {
    background: #ff9800;
    color: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
    text-align: center;
}

.header h1 {
    font-size: 28px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.logo-icon {
    width: 64px;
    height: 64px;
    vertical-align: middle;
    margin-right: 8px;
    border-radius: 4px;
    background: white;
    padding: 2px;
}

.site-info {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #2196f3;
}

.view-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
    font-weight: 500;
    transition: all 0.2s;
    min-height: 44px;
}

.btn-primary {
    background: #ff9800;
    color: white;
}

.btn-primary:hover {
    background: #f57c00;
}

.btn-outline {
    background: white;
    color: #ff9800;
    border: 2px solid #ff9800;
}

.btn-outline:hover {
    background: #ff9800;
    color: white;
}

.btn-active {
    background: #f57c00;
    color: white;
}

/* È°çÊªøÁõ∏ÈóúÊ®£Âºè */
.btn-disabled {
    background: #ccc !important;
    color: #666 !important;
    cursor: not-allowed !important;
    border-color: #ccc !important;
}

.capacity-info {
    display: inline-block;
    margin-left: 8px;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: bold;
}

.capacity-available {
    background: #4caf50;
    color: white;
}

.capacity-warning {
    background: #ff9800;
    color: white;
}

.capacity-full {
    background: #f44336;
    color: white;
}

.full-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(244, 67, 54, 0.9);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    border-radius: 12px;
    z-index: 10;
}

/* ÊúàÊõÜÊ®£Âºè */
.calendar-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 30px;
}

.calendar-header {
    background: #ff9800;
    color: white;
    padding: 20px;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.month-nav {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 4px;
    transition: background 0.2s;
}

.month-nav:hover {
    background: rgba(255, 255, 255, 0.1);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
}

.calendar-weekday {
    background: #fff3e0;
    padding: 15px 8px;
    text-align: center;
    font-weight: bold;
    color: #f57c00;
    border-bottom: 1px solid #ffe0b2;
}

.calendar-day {
    min-height: 140px;
    border: 1px solid #f0f0f0;
    padding: 10px;
    position: relative;
    background: white;
}

.calendar-day.other-month {
    background: #fafafa;
    color: #999;
}

.calendar-day.today {
    background: #fff3e0;
    border-color: #ff9800;
}

.day-number {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 4px;
    color: #666;
}

.day-events {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.calendar-event {
    background: #ff9800;
    color: white;
    padding: 6px 8px;
    border-radius: 4px;
    font-size: 16px;
    line-height: 1.3;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 3px;
    position: relative;
}

.calendar-event:hover {
    background: #f57c00;
    transform: translateY(-1px);
}

.calendar-event.selected {
    background: #4caf50;
    box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
}

.calendar-event.full {
    background: #f44336;
    cursor: not-allowed;
}

.calendar-event.warning {
    background: #ff9800;
}

/* ÂàóË°®Ê®£Âºè */
.events-grid {
    display: grid;
    gap: 20px;
}

.event-card {
    background: white;
    border: 2px solid #ddd;
    border-radius: 12px;
    padding: 24px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.event-card:hover {
    border-color: #ff9800;
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.15);
}

.event-card.selected {
    border-color: #4caf50;
    background: #f1f8e9;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
}

.event-card.full {
    background: #ffebee;
    border-color: #f44336;
    cursor: not-allowed;
}

.event-card.full:hover {
    border-color: #f44336;
    box-shadow: 0 4px 12px rgba(244, 67, 54, 0.15);
}

.event-header {
    display: flex;
    align-items: flex-start;
    margin-bottom: 15px;
}

.event-checkbox {
    width: 20px;
    height: 20px;
    margin-right: 15px;
    margin-top: 2px;
    flex-shrink: 0;
}

.event-checkbox:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.event-title {
    font-size: 20px;
    font-weight: 600;
    color: #ff9800;
    margin: 0;
    line-height: 1.3;
    flex-grow: 1;
}

.event-title.full {
    color: #f44336;
}

.event-details {
    color: #666;
    font-size: 18px;
    line-height: 1.5;
}

.event-details div {
    margin-bottom: 8px;
}

/* Ë°®ÂñÆÊ®£Âºè */
.form-section {
    background: white;
    padding: 30px;
    border-radius: 12px;
    margin-top: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
    font-size: 18px;
}

.required {
    color: #f44336;
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 18px;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: #ff9800;
    box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
}

.custom-fields {
    background: #fff3e0;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
    border-left: 4px solid #ff9800;
}

.custom-fields h4 {
    color: #f57c00;
    margin-bottom: 15px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 20px;
}

.error {
    background: #ffebee;
    color: #c62828;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #f44336;
    font-size: 18px;
}

.success {
    background: #e8f5e8;
    color: #2e7d32;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #4caf50;
}

/* È†ÅÈù¢Â∫ïÈÉ®Ê®£Âºè */
.footer {
    text-align: center;
    padding: 40px 20px 20px;
    margin-top: 50px;
    border-top: 1px solid #e0e0e0;
}

.footer-text {
    color: #666;
    font-size: 16px;
    margin-bottom: 15px;
}

.footer-logo {
    width: 80px;
    height: 80px;
    margin: 0 auto;
    display: block;
    border-radius: 8px;
    opacity: 0.8;
}

.hidden {
    display: none;
}

/* ÈüøÊáâÂºèË®≠Ë®à */
@media (max-width: 768px) {
    .container {
        padding: 15px;
    }

    .header h1 {
        font-size: 24px;
        flex-direction: column;
        gap: 8px;
    }

    .logo-icon {
        width: 56px;
        height: 56px;
        margin-right: 0;
        margin-bottom: 4px;
    }

    .view-toggle {
        flex-direction: column;
    }

    .calendar-header {
        font-size: 20px;
        padding: 15px;
    }

    .calendar-day {
        min-height: 100px;
        padding: 6px;
    }

    .calendar-event {
        font-size: 14px;
        padding: 4px 6px;
        margin-bottom: 2px;
    }

    .event-card {
        padding: 20px;
    }

    .event-title {
        font-size: 18px;
    }

    .form-control {
        font-size: 18px;
    }
}

@media (max-width: 480px) {
    .calendar-weekday {
        padding: 8px 4px;
        font-size: 14px;
    }

    .calendar-day {
        min-height: 70px;
        padding: 3px;
    }

    .day-number {
        font-size: 12px;
    }

    .calendar-event {
        font-size: 11px;
        padding: 2px 3px;
        margin-bottom: 1px;
    }
}
</style>
</head>
<body>
<div class="container">
    <!-- ÊìöÈªûÂêçÁ®±Â§ßÊ®ôÈ°å -->
    <div id="siteTitleHeader" class="site-title hidden"></div>

    <div class="header">
        <h1>
            <img src="https://godoor.umita.tw/wp-content/uploads/2023/10/%E6%9E%9C%E5%A4%9A-Logo-%E7%B0%A1%E5%96%AE%E5%BD%A9%E7%89%88-300x300.png" 
                 alt="ÊûúÂ§ö" 
                 class="logo-icon"> 
            Ê¥ªÂãïÂ†±ÂêçË°®ÂñÆ
        </h1>
        <p>ÈÅ∏ÊìáÊÇ®ÊÉ≥ÂèÉÂä†ÁöÑË™≤Á®ã</p>
    </div>

    <div id="siteInfo" class="site-info hidden">
        <strong>üìç Áï∂ÂâçÊìöÈªûÔºö</strong><span id="currentSite"></span>
    </div>

    <div class="view-toggle">
        <button class="btn btn-primary" onclick="loadEvents()">üîÑ ÈáçÊñ∞ËºâÂÖ•</button>
        <button class="btn btn-outline" id="calendarViewBtn" onclick="switchToCalendar()">üìÖ ÊúàÊõÜÊ™¢Ë¶ñ</button>
        <button class="btn btn-outline" id="listViewBtn" onclick="switchToList()">üìã ÂàóË°®Ê™¢Ë¶ñ</button>
        <button class="btn btn-outline" onclick="clearSelection()">üóëÔ∏è Ê∏ÖÈô§ÈÅ∏Êìá</button>
    </div>

    <!-- ÊúàÊõÜÊ™¢Ë¶ñ -->
    <div id="calendarView" class="calendar-container hidden">
        <div class="calendar-header">
            <button class="month-nav" onclick="changeMonth(-1)">‚Äπ</button>
            <span id="currentMonth"></span>
            <button class="month-nav" onclick="changeMonth(1)">‚Ä∫</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <!-- ÂàóË°®Ê™¢Ë¶ñ -->
    <div id="listView">
        <div id="eventsContainer">
            <div class="loading">ËºâÂÖ•‰∏≠...</div>
        </div>
    </div>

    <!-- Â∑≤ÈÅ∏Ë™≤Á®ãÊëòË¶Å -->
    <div id="selectedSummary" class="hidden" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
        <h3 style="color: #4caf50; margin-bottom: 10px;">‚úÖ Â∑≤ÈÅ∏ÊìáÁöÑË™≤Á®ã</h3>
        <div id="selectedList"></div>
    </div>

    <div class="form-section">
        <h3 style="margin-bottom: 20px; color: #ff9800;">üìù Â†±ÂêçË≥áÊñô</h3>
        <form id="signupForm">
            <div class="form-group">
                <label class="form-label">ÂßìÂêç <span class="required">*</span></label>
                <input type="text" class="form-control" name="name" required placeholder="Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂßìÂêç">
            </div>

            <div class="form-group">
                <label class="form-label">LINEÂêçÁ®± <span class="required">*</span></label>
                <input type="text" class="form-control" name="lineName" required placeholder="Ë´ãËº∏ÂÖ•ÊÇ®Âú®LINE‰∏äÈ°ØÁ§∫ÁöÑÂêçÁ®±">
            </div>

            <div class="form-group">
                <label class="form-label">ÊâãÊ©üËôüÁ¢º <span class="required">*</span></label>
                <input type="tel" class="form-control" name="phone" required placeholder="‰æãÂ¶ÇÔºö0912345678">
            </div>

            <div class="form-group">
                <label class="form-label">ÈõªÂ≠êÈÉµ‰ª∂</label>
                <input type="email" class="form-control" name="email" placeholder="‰æãÂ¶ÇÔºöexample@gmail.com">
            </div>

            <div class="form-group">
                <label class="form-label">ÊÄßÂà•</label>
                <select class="form-control" name="gender">
                    <option value="">Ë´ãÈÅ∏Êìá</option>
                    <option value="Áî∑">Áî∑</option>
                    <option value="Â•≥">Â•≥</option>
                    <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Âπ¥ÈΩ°</label>
                <input type="number" class="form-control" name="age" min="1" max="120" placeholder="Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂπ¥ÈΩ°">
            </div>

            <div class="form-group">
                <label class="form-label">ÂÇôË®ª</label>
                <textarea class="form-control" name="note" rows="3" placeholder="Â¶ÇÊúâÁâπÊÆäÈúÄÊ±ÇÊàñÊÉ≥Ë¶ÅË£úÂÖÖÁöÑË≥áË®äÔºåË´ãÂú®Ê≠§Â°´ÂØ´"></textarea>
            </div>
            <!-- Èö±ËóèÁöÑ LINE ID Ê¨Ñ‰Ωç -->
                <input type="hidden" name="lineId" id="lineIdField">
            <!-- Ëá™Ë®ÇÊ¨Ñ‰ΩçÂçÄÂüü -->
            <div id="customFields" class="hidden"></div>

            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 18px;">
                ‚úÖ ÈÄÅÂá∫Â†±Âêç
            </button>
        </form>
    </div>
    
    <!-- È†ÅÈù¢Â∫ïÈÉ® -->
    <div class="footer">
        <div class="footer-text">Powered by ÊûúÂ§ö</div>
        <img src="https://godoor.umita.tw/wp-content/uploads/2023/10/%E6%9E%9C%E5%A4%9A-Logo-%E7%B0%A1%E5%96%AE%E5%BD%A9%E7%89%88-300x300.png" 
             alt="ÊûúÂ§ö" 
             class="footer-logo">
    </div>
</div>

<script>
// ÈÖçÁΩÆ
const API_URL = 'https://script.google.com/macros/s/AKfycbxpDCRA2PJXLy8ssWwG3NO4QZzg87gmUdB1vHWjYNdf9jmz-ku0yfnovhtfz58ep0oE/exec';

// LIFF ÈÖçÁΩÆ
const LIFF_ID = '2007618883-ewZnj9Py'; // Ë´ãÊõøÊèõÁÇ∫ÂØ¶ÈöõÁöÑ LIFF ID
let userProfile = null;
let isLiffReady = false;

// ÁãÄÊÖã
let events = [];
let selectedEventIds = [];
let currentView = 'list';
let currentDate = new Date();

// Âæû URL Áç≤ÂèñÊìöÈªûÂèÉÊï∏
const urlParams = new URLSearchParams(window.location.search);
const siteKeyword = urlParams.get('site') || '';

// ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    if (siteKeyword) {
        document.getElementById('siteInfo').classList.remove('hidden');
        document.getElementById('currentSite').textContent = siteKeyword;

        // È°ØÁ§∫ÊìöÈªûÂêçÁ®±Â§ßÊ®ôÈ°å
        const siteTitleHeader = document.getElementById('siteTitleHeader');
        siteTitleHeader.textContent = siteKeyword;
        siteTitleHeader.classList.remove('hidden');
    }

    loadEvents();
    setupForm();
    updateViewButtons();
    
    // Êñ∞Â¢ûÔºöÂàùÂßãÂåñ LIFF
    initializeLiff();
});

// ËºâÂÖ•Ê¥ªÂãï
async function loadEvents() {
    const container = document.getElementById('eventsContainer');
    container.innerHTML = '<div class="loading">ËºâÂÖ•‰∏≠...</div>';

    try {
        const url = `${API_URL}?mode=events&site=${encodeURIComponent(siteKeyword)}`;
        console.log('ËºâÂÖ• URL:', url);

        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        console.log('Êî∂Âà∞Ë≥áÊñô:', data);

        if (data.error) {
            throw new Error(data.error);
        }

        events = Array.isArray(data) ? data : data.events || [];
        console.log('Ê¥ªÂãïÊï∏Èáè:', events.length);

        // Ê†πÊìöÁï∂ÂâçÊ™¢Ë¶ñÊ®°ÂºèÊ∏≤Êüì
        if (currentView === 'calendar') {
            renderCalendar();
        } else {
            renderEventsList();
        }

    } catch (error) {
        console.error('ËºâÂÖ•ÈåØË™§:', error);
        container.innerHTML = `
            <div class="error">
                <h4>ËºâÂÖ•Â§±Êïó</h4>
                <p>ÈåØË™§Ôºö${error.message}</p>
                <p>Ë´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑öÊàñÁ®çÂæåÂÜçË©¶</p>
            </div>
        `;
    }
}

// ÂàáÊèõÂà∞ÊúàÊõÜÊ™¢Ë¶ñ
function switchToCalendar() {
    currentView = 'calendar';
    updateViewButtons();
    document.getElementById('listView').classList.add('hidden');
    document.getElementById('calendarView').classList.remove('hidden');
    renderCalendar();
}

// ÂàáÊèõÂà∞ÂàóË°®Ê™¢Ë¶ñ
function switchToList() {
    currentView = 'list';
    updateViewButtons();
    document.getElementById('calendarView').classList.add('hidden');
    document.getElementById('listView').classList.remove('hidden');
    renderEventsList();
}

// Êõ¥Êñ∞Ê™¢Ë¶ñÊåâÈàïÁãÄÊÖã
function updateViewButtons() {
    const calendarBtn = document.getElementById('calendarViewBtn');
    const listBtn = document.getElementById('listViewBtn');

    if (currentView === 'calendar') {
        calendarBtn.classList.add('btn-active');
        calendarBtn.classList.remove('btn-outline');
        listBtn.classList.add('btn-outline');
        listBtn.classList.remove('btn-active');
    } else {
        listBtn.classList.add('btn-active');
        listBtn.classList.remove('btn-outline');
        calendarBtn.classList.add('btn-outline');
        calendarBtn.classList.remove('btn-active');
    }
}

// Ê∏≤ÊüìÊúàÊõÜ
function renderCalendar() {
    const monthDisplay = document.getElementById('currentMonth');
    const calendarGrid = document.getElementById('calendarGrid');

    // Ë®≠ÂÆöÊúà‰ªΩÈ°ØÁ§∫
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    monthDisplay.textContent = `${year}Âπ¥ ${month + 1}Êúà`;

    // Ê∏ÖÁ©∫ÁèæÊúâÂÖßÂÆπ
    calendarGrid.innerHTML = '';

    // Âª∫Á´ãÊòüÊúüÊ®ôÈ°å
    const weekdays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
    weekdays.forEach(day => {
        const weekdayDiv = document.createElement('div');
        weekdayDiv.className = 'calendar-weekday';
        weekdayDiv.textContent = day;
        calendarGrid.appendChild(weekdayDiv);
    });

    // ÂèñÂæóÊú¨ÊúàÁ¨¨‰∏ÄÂ§©ÂíåÊúÄÂæå‰∏ÄÂ§©
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const firstDayWeekday = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    // ÂèñÂæó‰∏äÂÄãÊúàÁöÑÊúÄÂæåÂπæÂ§©
    const prevMonth = new Date(year, month, 0);
    const daysInPrevMonth = prevMonth.getDate();

    // Â°´ÂÖ•‰∏äÂÄãÊúàÁöÑÊó•Êúü
    for (let i = firstDayWeekday - 1; i >= 0; i--) {
        const dayDiv = createCalendarDay(daysInPrevMonth - i, true);
        calendarGrid.appendChild(dayDiv);
    }

    // Â°´ÂÖ•Êú¨ÊúàÁöÑÊó•Êúü
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = createCalendarDay(day, false);
        calendarGrid.appendChild(dayDiv);
    }

    // Â°´ÂÖ•‰∏ãÂÄãÊúàÁöÑÊó•Êúü
    const totalCells = calendarGrid.children.length - 7; // Ê∏õÂéªÊòüÊúüÊ®ôÈ°å
    const remainingCells = 42 - totalCells; // 6ÈÄ± * 7Â§© = 42Ê†º
    for (let day = 1; day <= remainingCells; day++) {
        const dayDiv = createCalendarDay(day, true);
        calendarGrid.appendChild(dayDiv);
    }
}

// Âª∫Á´ãÊúàÊõÜÊó•ÊúüÊ†ºÂ≠ê
function createCalendarDay(dayNumber, isOtherMonth) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'calendar-day';

    if (isOtherMonth) {
        dayDiv.classList.add('other-month');
    }

    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫‰ªäÂ§©
    const today = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth();

    if (!isOtherMonth &&
        today.getDate() === dayNumber &&
        today.getMonth() === currentMonth &&
        today.getFullYear() === currentYear) {
        dayDiv.classList.add('today');
    }

    // Âª∫Á´ãÊó•ÊúüÊï∏Â≠ó
    const dayNumberDiv = document.createElement('div');
    dayNumberDiv.className = 'day-number';
    dayNumberDiv.textContent = dayNumber;
    dayDiv.appendChild(dayNumberDiv);

    // Âª∫Á´ãÊ¥ªÂãïÂàóË°®
    const eventsDiv = document.createElement('div');
    eventsDiv.className = 'day-events';

    if (!isOtherMonth) {
        // Â∞ãÊâæË©≤Êó•ÁöÑÊ¥ªÂãï
        const dayEvents = findEventsForDate(currentYear, currentMonth, dayNumber);
        dayEvents.forEach(event => {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'calendar-event';
            
            // Ê™¢Êü•È°çÊªøÁãÄÊÖã
            if (event.isFull) {
                eventDiv.classList.add('full');
            } else if (event.remainingSlots !== null && event.remainingSlots <= 3) {
                eventDiv.classList.add('warning');
            }
            
            if (selectedEventIds.includes(event['Ê¥ªÂãïID']) && !event.isFull) {
                eventDiv.classList.add('selected');
            }

            // È°ØÁ§∫ÊôÇÈñìÂíåÊ®ôÈ°å
            const timeStr = formatTime(event['ÈñãÂßãÊôÇÈñì']);
            let displayText = `${timeStr} ${event['Ê¥ªÂãïÊ®ôÈ°å']}`;
            
            // Âä†ÂÖ•ÂÆπÈáèË≥áË®ä
            if (event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê'] && !isNaN(parseInt(event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê']))) {
                if (event.isFull) {
                    displayText += ' [È°çÊªø]';
                } else if (event.remainingSlots <= 3) {
                    displayText += ` [Ââ©${event.remainingSlots}]`;
                }
            }
            
            eventDiv.textContent = displayText;
            
            // Ë®≠ÂÆöÊèêÁ§∫ÊñáÂ≠ó - ‰øÆÊ≠£Â†±ÂêçÁãÄÊ≥ÅÈ°ØÁ§∫ÈÇèËºØ
            const currentCount = event.currentRegistrations || 0;
            let tooltipText = `${event['Ê¥ªÂãïÊ®ôÈ°å']}\nË¨õÂ∏´Ôºö${event['Ë¨õÂ∏´'] || 'ÂæÖÁ¢∫Ë™ç'}\nÊôÇÈñìÔºö${timeStr}`;
            
            if (event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê'] && !isNaN(parseInt(event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê']))) {
                const maxCapacity = parseInt(event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê']);
                if (currentCount === 0) {
                    tooltipText += `\nÂ†±ÂêçÔºöÂ†±Âêç‰∏≠/${maxCapacity}`;
                } else if (event.isFull) {
                    tooltipText += `\nÂ†±ÂêçÔºö${currentCount}/${maxCapacity} (Â∑≤È°çÊªø)`;
                } else if (event.remainingSlots <= 3) {
                    tooltipText += `\nÂ†±ÂêçÔºöÂç≥Â∞áÈ°çÊªø/${maxCapacity}`;
                } else {
                    tooltipText += `\nÂ†±ÂêçÔºö${currentCount}/${maxCapacity}`;
                }
            } else {
                if (currentCount === 0) {
                    tooltipText += `\nÂ†±ÂêçÔºöÂ†±Âêç‰∏≠`;
                } else {
                    tooltipText += `\nÂ†±ÂêçÔºö${currentCount}‰∫∫Â∑≤Â†±Âêç`;
                }
            }
            
            eventDiv.title = tooltipText;

            eventDiv.onclick = (e) => {
                e.stopPropagation();
                if (!event.isFull) {
                    toggleEvent(event['Ê¥ªÂãïID']);
                } else {
                    alert(`ÂæàÊä±Ê≠âÔºå„Äå${event['Ê¥ªÂãïÊ®ôÈ°å']}„ÄçÂ∑≤È°çÊªøÔºÅ`);
                }
            };

            eventsDiv.appendChild(eventDiv);
        });
    }

    dayDiv.appendChild(eventsDiv);
    return dayDiv;
}

// Â∞ãÊâæÁâπÂÆöÊó•ÊúüÁöÑÊ¥ªÂãï
function findEventsForDate(year, month, day) {
    const targetDate = new Date(year, month, day);
    return events.filter(event => {
        const eventDate = new Date(event['Ê¥ªÂãïÊó•Êúü']);
        return eventDate.getFullYear() === year &&
               eventDate.getMonth() === month &&
               eventDate.getDate() === day;
    });
}

// ÊîπËÆäÊúà‰ªΩ
function changeMonth(direction) {
    currentDate.setMonth(currentDate.getMonth() + direction);
    renderCalendar();
}

// Ê∏≤ÊüìÊ¥ªÂãïÂàóË°®
function renderEventsList() {
    const container = document.getElementById('eventsContainer');

    if (events.length === 0) {
        container.innerHTML = `
            <div class="error">
                <h4>Ê≤íÊúâÊâæÂà∞Ë™≤Á®ã</h4>
                <p>ÁõÆÂâçÊ≤íÊúâÂèØÂ†±ÂêçÁöÑË™≤Á®ã</p>
            </div>
        `;
        return;
    }

    // ÊåâÊó•ÊúüÊéíÂ∫èÊ¥ªÂãï
    const sortedEvents = [...events].sort((a, b) => {
        const dateA = new Date(a['Ê¥ªÂãïÊó•Êúü']);
        const dateB = new Date(b['Ê¥ªÂãïÊó•Êúü']);
        return dateA - dateB;
    });

    const html = sortedEvents.map(event => {
        const isFull = event.isFull;
        const hasLimit = event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê'] && !isNaN(parseInt(event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê']));
        const currentCount = event.currentRegistrations || 0;
        const isWarning = hasLimit && event.remainingSlots <= 3 && !isFull;
        
        let capacityInfo = '';
        if (hasLimit) {
            const maxCapacity = parseInt(event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê']);
            let displayText = '';
            
            if (currentCount === 0) {
                displayText = `Â†±Âêç‰∏≠/${maxCapacity}`;
            } else if (isFull) {
                displayText = `${currentCount}/${maxCapacity}`;
            } else if (isWarning) {
                displayText = `Âç≥Â∞áÈ°çÊªø/${maxCapacity}`;
            } else {
                displayText = `${currentCount}/${maxCapacity}`;
            }
            
            const capacityClass = isFull ? 'capacity-full' : 
                                 isWarning ? 'capacity-warning' : 
                                 'capacity-available';
            capacityInfo = `<span class="capacity-info ${capacityClass}">${displayText}</span>`;
        }

        return `
            <div class="event-card ${isFull ? 'full' : ''} ${selectedEventIds.includes(event['Ê¥ªÂãïID']) && !isFull ? 'selected' : ''}" 
                 data-event-id="${event['Ê¥ªÂãïID']}" 
                 onclick="${isFull ? `alert('ÂæàÊä±Ê≠âÔºåÊ≠§Ê¥ªÂãïÂ∑≤È°çÊªøÔºÅ')` : `toggleEvent('${event['Ê¥ªÂãïID']}')`}">
                
                ${isFull ? '<div class="full-overlay">üö´ Â∑≤È°çÊªø</div>' : ''}
                
                <div class="event-header">
                    <input type="checkbox" class="event-checkbox" 
                           ${selectedEventIds.includes(event['Ê¥ªÂãïID']) && !isFull ? 'checked' : ''} 
                           ${isFull ? 'disabled' : ''}>
                    <h3 class="event-title ${isFull ? 'full' : ''}">${event['Ê¥ªÂãïÊ®ôÈ°å']} ${capacityInfo}</h3>
                </div>
                <div class="event-details">
                    <div>üë®‚Äçüè´ Ë¨õÂ∏´Ôºö${event['Ë¨õÂ∏´'] || 'ÂæÖÁ¢∫Ë™ç'}</div>
                    <div>üìÖ Êó•ÊúüÔºö${formatDate(event['Ê¥ªÂãïÊó•Êúü'])}</div>
                    <div>üïê ÊôÇÈñìÔºö${formatTime(event['ÈñãÂßãÊôÇÈñì'])}</div>
                    <div>üìç Âú∞ÈªûÔºö${event['Âú∞ÂùÄÊàñÂú∞ÈªûË™™Êòé'] || 'ÂæÖÁ¢∫Ë™ç'}</div>
                    ${hasLimit ? 
                        `<div>üë• Â†±ÂêçÁãÄÊ≥ÅÔºö${currentCount === 0 ? 'Â†±Âêç‰∏≠' : 
                            isFull ? `${currentCount}/${event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê']} (Â∑≤È°çÊªø)` : 
                            isWarning ? `Âç≥Â∞áÈ°çÊªø/${event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê']}` : 
                            `${currentCount}/${event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê']}`}</div>` : 
                        `<div>üë• Â†±ÂêçÁãÄÊ≥ÅÔºö${currentCount === 0 ? 'Â†±Âêç‰∏≠' : `${currentCount}‰∫∫Â∑≤Â†±Âêç`}</div>`
                    }
                    ${event['Ê¥ªÂãïÂÖßÂÆπ'] ? `<div>üìã ÂÖßÂÆπÔºö${event['Ê¥ªÂãïÂÖßÂÆπ']}</div>` : ''}
                    ${event['ÂÇôË®ª'] ? `<div>‚ö†Ô∏è ÂÇôË®ªÔºö${event['ÂÇôË®ª']}</div>` : ''}
                    ${event['Ëá™Ë®ÇÊ¨Ñ‰ΩçÂïèÈ°å'] ? `<div>‚ùì ÂïèÈ°åÔºö${event['Ëá™Ë®ÇÊ¨Ñ‰ΩçÂïèÈ°å']}</div>` : ''}
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = `<div class="events-grid">${html}</div>`;
    updateEventCards();
}

// ÂàáÊèõÊ¥ªÂãïÈÅ∏Êìá
function toggleEvent(eventId) {
    // Ê™¢Êü•Ê¥ªÂãïÊòØÂê¶È°çÊªø
    const event = events.find(e => e['Ê¥ªÂãïID'] === eventId);
    if (event && event.isFull) {
        alert(`ÂæàÊä±Ê≠âÔºå„Äå${event['Ê¥ªÂãïÊ®ôÈ°å']}„ÄçÂ∑≤È°çÊªøÔºÅ`);
        return;
    }

    const index = selectedEventIds.indexOf(eventId);

    if (index > -1) {
        selectedEventIds.splice(index, 1);
    } else {
        selectedEventIds.push(eventId);
    }

    // Êõ¥Êñ∞È°ØÁ§∫
    if (currentView === 'calendar') {
        renderCalendar();
    } else {
        updateEventCards();
    }

    updateSelectedSummary();
    updateCustomFields();
}

// Êõ¥Êñ∞Ê¥ªÂãïÂç°ÁâáÈÅ∏ÊìáÁãÄÊÖã
function updateEventCards() {
    document.querySelectorAll('.event-card').forEach(card => {
        const eventId = card.dataset.eventId;
        const checkbox = card.querySelector('.event-checkbox');
        const isSelected = selectedEventIds.includes(eventId);
        const event = events.find(e => e['Ê¥ªÂãïID'] === eventId);
        const isFull = event && event.isFull;

        if (isSelected && !isFull) {
            card.classList.add('selected');
            checkbox.checked = true;
        } else {
            card.classList.remove('selected');
            checkbox.checked = false;
        }
    });
}

// Êõ¥Êñ∞Â∑≤ÈÅ∏Ë™≤Á®ãÊëòË¶Å
function updateSelectedSummary() {
    const summaryDiv = document.getElementById('selectedSummary');
    const listDiv = document.getElementById('selectedList');

    if (selectedEventIds.length === 0) {
        summaryDiv.classList.add('hidden');
        return;
    }

    const selectedEvents = events.filter(event =>
        selectedEventIds.includes(event['Ê¥ªÂãïID'])
    );

    const html = selectedEvents.map(event => {
        const currentCount = event.currentRegistrations || 0;
        let capacityText = '';
        
        if (event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê'] && !isNaN(parseInt(event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê']))) {
            const maxCapacity = parseInt(event['Ê¥ªÂãï‰∫∫Êï∏‰∏äÈôê']);
            if (currentCount === 0) {
                capacityText = ` (Â†±Âêç‰∏≠/${maxCapacity})`;
            } else {
                capacityText = ` (${currentCount}/${maxCapacity})`;
            }
        } else {
            if (currentCount === 0) {
                capacityText = ' (Â†±Âêç‰∏≠)';
            } else {
                capacityText = ` (${currentCount}‰∫∫Â∑≤Â†±Âêç)`;
            }
        }
        
        return `
            <div style="margin-bottom: 8px; padding: 8px; background: #f0f9ff; border-radius: 4px;">
                <strong>${event['Ê¥ªÂãïÊ®ôÈ°å']}</strong>${capacityText}<br>
                <small>üìÖ ${formatDate(event['Ê¥ªÂãïÊó•Êúü'])} üïê ${formatTime(event['ÈñãÂßãÊôÇÈñì'])}</small>
            </div>
        `;
    }).join('');

    listDiv.innerHTML = html;
    summaryDiv.classList.remove('hidden');
}

// Êõ¥Êñ∞Ëá™Ë®ÇÊ¨Ñ‰Ωç
function updateCustomFields() {
    const customFieldsDiv = document.getElementById('customFields');
    const selectedEvents = events.filter(event =>
        selectedEventIds.includes(event['Ê¥ªÂãïID'])
    );

    // ÊâæÂá∫ÊúâËá™Ë®ÇÂïèÈ°åÁöÑÊ¥ªÂãï
    const eventsWithCustomFields = selectedEvents.filter(event =>
        event['Ëá™Ë®ÇÊ¨Ñ‰ΩçÂïèÈ°å'] && event['Ëá™Ë®ÇÊ¨Ñ‰ΩçÂïèÈ°å'].trim()
    );

    if (eventsWithCustomFields.length === 0) {
        customFieldsDiv.classList.add('hidden');
        customFieldsDiv.innerHTML = '';
        return;
    }

    let html = '<div class="custom-fields"><h4>üìã Ë™≤Á®ãÁõ∏ÈóúÂïèÈ°å</h4>';

    eventsWithCustomFields.forEach(event => {
        html += `
            <div class="form-group">
                <label class="form-label">${event['Ê¥ªÂãïÊ®ôÈ°å']} - ${event['Ëá™Ë®ÇÊ¨Ñ‰ΩçÂïèÈ°å']}</label>
                <textarea class="form-control" name="custom_${event['Ê¥ªÂãïID']}" rows="2"
                          placeholder="Ë´ãÂõûÁ≠îÊ≠§ÂïèÈ°å..."></textarea>
            </div>
        `;
    });

    html += '</div>';
    customFieldsDiv.innerHTML = html;
    customFieldsDiv.classList.remove('hidden');
}

// Ê∏ÖÈô§ÈÅ∏Êìá
function clearSelection() {
    selectedEventIds = [];

    if (currentView === 'calendar') {
        renderCalendar();
    } else {
        updateEventCards();
    }

    updateSelectedSummary();
    updateCustomFields();
}

// Ë®≠ÁΩÆË°®ÂñÆ
function setupForm() {
    document.getElementById('signupForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        if (selectedEventIds.length === 0) {
            alert('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãË™≤Á®ã');
            return;
        }

        // Ê™¢Êü•ÈÅ∏ÊìáÁöÑË™≤Á®ãÊòØÂê¶ÊúâÈ°çÊªøÁöÑ
        const selectedEvents = events.filter(event => selectedEventIds.includes(event['Ê¥ªÂãïID']));
        const fullEvents = selectedEvents.filter(event => event.isFull);
        
        if (fullEvents.length > 0) {
            alert(`ÂæàÊä±Ê≠âÔºå‰ª•‰∏ãË™≤Á®ãÂ∑≤È°çÊªøÔºåË´ãÈáçÊñ∞ÈÅ∏ÊìáÔºö\n${fullEvents.map(e => e['Ê¥ªÂãïÊ®ôÈ°å']).join('\n')}`);
            return;
        }

        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');

        submitBtn.disabled = true;
        submitBtn.textContent = 'Â†±Âêç‰∏≠...';

        let successCount = 0;
        let errorMessages = [];

        try {
            for (const eventId of selectedEventIds) {
                // Êî∂ÈõÜËá™Ë®ÇÊ¨Ñ‰ΩçÂõûÁ≠î
                const customAnswer = formData.get(`custom_${eventId}`) || '';

                // ÂèñÂæó LINE IDÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
                const lineId = document.getElementById('lineIdField')?.value || '';

                const data = new URLSearchParams({
                    action: 'register',
                    eventId: eventId,
                    name: formData.get('name'),
                    lineName: formData.get('lineName'),
                    lineId: lineId, // Êñ∞Â¢ûÔºöÂÇ≥ÈÄÅ LINE ID
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    gender: formData.get('gender'),
                    age: formData.get('age'),
                    note: formData.get('note'),
                    customFieldAnswer: customAnswer
                });

                // Ë®òÈåÑÊèê‰∫§Ë≥áÊñôÔºàÈô§ÈåØÁî®Ôºâ
                console.log('üì§ Êèê‰∫§Ë≥áÊñôÂåÖÂê´ LINE ID:', {
                    name: formData.get('name'),
                    lineId: lineId ? 'Êúâ' : 'ÁÑ°',
                    isLiff: isLiffReady
                });

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: data
                });

                const result = await response.json();

                if (result.error || !result.success) {
                    const event = events.find(e => e['Ê¥ªÂãïID'] === eventId);
                    const eventTitle = event ? event['Ê¥ªÂãïÊ®ôÈ°å'] : eventId;
                    errorMessages.push(`${eventTitle}: ${result.error || 'Êú™Áü•ÈåØË™§'}`);
                } else {
                    successCount++;
                }
            }

            // ÈáçÊñ∞ËºâÂÖ•Ê¥ªÂãïË≥áÊñô‰ª•Êõ¥Êñ∞ÂÆπÈáèÁãÄÊÖã
            await loadEvents();

            if (successCount > 0) {
                // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
                const successMsg = document.createElement('div');
                successMsg.className = 'success';
                successMsg.innerHTML = `
                    <h4>üéâ Â†±ÂêçÊàêÂäüÔºÅ</h4>
                    <p>ÊÇ®Â∑≤ÊàêÂäüÂ†±Âêç ${successCount} ÂÄãË™≤Á®ã</p>
                    ${errorMessages.length > 0 ? `<p style="color: #ff9800;">ÈÉ®ÂàÜË™≤Á®ãÂ†±ÂêçÂ§±ÊïóÔºö<br>${errorMessages.join('<br>')}</p>` : ''}
                    <p>ÊàëÂÄëÊúÉÂú®Ê¥ªÂãïÂâç‰∏ÄÂ§©ÊèêÈÜíÊÇ®ÔºåË´ãÊ∫ñÊôÇÂèÉÂä†ÔºÅ</p>
                `;

                this.parentNode.insertBefore(successMsg, this);

                // Ê∏ÖÈô§Ë°®ÂñÆÂíåÈÅ∏Êìá
                this.reset();
                clearSelection();

                // 5ÁßíÂæåÁßªÈô§ÊàêÂäüË®äÊÅØ
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.parentNode.removeChild(successMsg);
                    }
                }, 5000);
            } else {
                throw new Error(errorMessages.join('\n'));
            }

        } catch (error) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'error';
            errorMsg.innerHTML = `
                <h4>‚ùå Â†±ÂêçÂ§±Êïó</h4>
                <p>${error.message}</p>
            `;
            this.parentNode.insertBefore(errorMsg, this);

            setTimeout(() => {
                if (errorMsg.parentNode) {
                    errorMsg.parentNode.removeChild(errorMsg);
                }
            }, 5000);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '‚úÖ ÈÄÅÂá∫Â†±Âêç';
        }
    });
}

// Ê†ºÂºèÂåñÊó•Êúü
function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
        const date = new Date(dateStr);
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const weekdays = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
        const weekday = weekdays[date.getDay()];
        return `${month}/${day} (${weekday})`;
    } catch {
        return dateStr;
    }
}

// Ê†ºÂºèÂåñÊôÇÈñì
function formatTime(timeStr) {
    if (!timeStr) return '';
    try {
        if (timeStr.toString().includes('1899')) {
            const date = new Date(timeStr);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        return timeStr;
    } catch {
        return timeStr;
    }
}

// ÈçµÁõ§Âø´Êç∑Èçµ
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + L: ÂàáÊèõÂà∞ÂàóË°®Ê™¢Ë¶ñ
    if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
        e.preventDefault();
        switchToList();
    }

    // Ctrl/Cmd + C: ÂàáÊèõÂà∞ÊúàÊõÜÊ™¢Ë¶ñ
    if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        e.preventDefault();
        switchToCalendar();
    }

    // Escape: Ê∏ÖÈô§ÈÅ∏Êìá
    if (e.key === 'Escape') {
        clearSelection();
    }
});

// Ëß∏ÊéßÊâãÂã¢ÊîØÊè¥ÔºàÊâãÊ©üÊªëÂãïÂàáÊèõÊúà‰ªΩÔºâ
let touchStartX = 0;
let touchEndX = 0;

document.getElementById('calendarView').addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
});

document.getElementById('calendarView').addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    const swipeThreshold = 50;
    const swipeDistance = touchEndX - touchStartX;

    if (Math.abs(swipeDistance) > swipeThreshold) {
        if (swipeDistance > 0) {
            // ÂêëÂè≥ÊªëÂãï - ‰∏äÂÄãÊúà
            changeMonth(-1);
        } else {
            // ÂêëÂ∑¶ÊªëÂãï - ‰∏ãÂÄãÊúà
            changeMonth(1);
        }
    }
}

// È†ÅÈù¢ÂèØË¶ãÊÄßËÆäÊõ¥ÊôÇÈáçÊñ∞ËºâÂÖ•ÔºàÈÅøÂÖçË≥áÊñôÈÅéÊúüÔºâ
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        // Â¶ÇÊûúË∂ÖÈÅé5ÂàÜÈêòÊ≤íÊúâÈáçÊñ∞ËºâÂÖ•ÔºåËá™ÂãïÈáçÊñ∞ËºâÂÖ•
        const lastLoad = localStorage.getItem('lastEventLoad');
        const now = Date.now();
        if (!lastLoad || (now - parseInt(lastLoad)) > 5 * 60 * 1000) {
            loadEvents();
            localStorage.setItem('lastEventLoad', now.toString());
        }
    }
});

// Ë®≠ÂÆöÂàùÂßãËºâÂÖ•ÊôÇÈñì
localStorage.setItem('lastEventLoad', Date.now().toString());

/**
 * LIFF Áõ∏ÈóúÂáΩÂºè
 */
async function initializeLiff() {
    try {
        console.log('üîÑ Ê™¢Êü• LIFF Áí∞Â¢É...');
        
        if (typeof liff === 'undefined') {
            console.log('‚ö†Ô∏è ‰∏çÂú® LIFF Áí∞Â¢É‰∏≠Ôºå‰ΩøÁî®‰∏ÄËà¨Ê®°Âºè');
            return;
        }
        
        await liff.init({ liffId: LIFF_ID });
        
        if (liff.isLoggedIn()) {
            console.log('‚úÖ LIFF ÁôªÂÖ•ÊàêÂäü');
            await getUserProfile();
            isLiffReady = true;
            showLiffStatus();
        } else {
            console.log('‚ùå LIFF Êú™ÁôªÂÖ•ÔºåÂòóË©¶ÁôªÂÖ•...');
            liff.login();
        }
        
    } catch (error) {
        console.error('‚ùå LIFF ÂàùÂßãÂåñÂ§±Êïó:', error);
    }
}

async function getUserProfile() {
    try {
        userProfile = await liff.getProfile();
        console.log('üë§ LIFF ‰ΩøÁî®ËÄÖË≥áÊñô:', userProfile);
        
        const lineNameField = document.querySelector('input[name="lineName"]');
        const lineIdField = document.getElementById('lineIdField');
        
        if (lineNameField && userProfile.displayName) {
            lineNameField.value = userProfile.displayName;
            lineNameField.readOnly = true;
        }
        
        if (lineIdField && userProfile.userId) {
            lineIdField.value = userProfile.userId;
        }
        
        console.log('‚úÖ LIFF ‰ΩøÁî®ËÄÖË≥áÊñôÂ∑≤Ëá™ÂãïÂ°´ÂÖ•');
        
    } catch (error) {
        console.error('‚ùå ÂèñÂæó LIFF ‰ΩøÁî®ËÄÖË≥áÊñôÂ§±Êïó:', error);
    }
}

function showLiffStatus() {
    const header = document.querySelector('.header p');
    if (header && userProfile) {
        header.innerHTML = `ÈÅ∏ÊìáÊÇ®ÊÉ≥ÂèÉÂä†ÁöÑË™≤Á®ã<br><small style="color: rgba(255,255,255,0.8);">üëã Ê≠°ËøéÔºå${userProfile.displayName}ÔºÅ</small>`;
    }
}
</script>
</body>
</html>
