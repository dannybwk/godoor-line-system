// ===== Config.gs =====
const SHEET_ID = '13IwMmUYPOCrQOpF7yBnjtM0whoMOxfQb2wpQkoPGYnY';
const LINE_CHANNEL_ACCESS_TOKEN = '5kEpFZCsp8+Ia4/dSTkMQ2PvybJFlZ9hkhxqSl76lf7GHw/3tKenyddqh+ndBHws+aEr25QY7uc3DMJsllW5JhftSPmXSXGIltzEw/JhFuyRENL2qSWZEYCUTVwiILjD2KTg5SD9vW6lT4g5bBcurwdB04t89/1O/w1cDnyilFU=';

// ===== Main.gs =====
function doGet(e) {
  const params = e.parameter || {};
  const mode = params.mode;
  const site = params.site || '';
  
  try {
    if (mode === 'events') {
      return getEvents(site);
    }
    
    return createJsonResponse({ error: 'Invalid mode' });
  } catch (error) {
    return createJsonResponse({ error: error.toString() });
  }
}

function doPost(e) {
  const params = e.parameter || {};
  const action = params.action;
  
  try {
    if (action === 'register') {
      return registerEvent(params);
    }
    
    return createJsonResponse({ error: 'Invalid action' });
  } catch (error) {
    return createJsonResponse({ error: error.toString() });
  }
}

function getEvents(site) {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('活動總表');
  const data = sheet.getDataRange().getValues();
  
  if (data.length <= 1) {
    return createJsonResponse([]);
  }
  
  const headers = data[0];
  const rows = data.slice(1);
  
  // 轉換為物件陣列
  let events = rows.map(row => {
    const event = {};
    headers.forEach((header, index) => {
      event[header] = row[index];
    });
    return event;
  });
  
  // 據點篩選
  if (site) {
    events = events.filter(event => {
      const organizer = (event['活動主辦人或單位'] || '').toString();
      return organizer.includes(site) || 
             organizer.includes(site.replace('@', '')) ||
             (`@${organizer}`).includes(site);
    });
  }
  
  return createJsonResponse(events);
}

function registerEvent(params) {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('報名紀錄表');
  const now = new Date();
  
  const row = [
    Utilities.formatDate(now, 'Asia/Taipei', 'yyyy/MM/dd HH:mm:ss'),
    params.name || '',
    params.lineName || '',
    params.lineId || '',
    params.email || '',
    params.phone || '',
    params.note || '',
    params.eventId || '',
    '',
    params.gender || '',
    params.age || '',
    params.customFieldAnswer || ''
  ];
  
  sheet.appendRow(row);
  
  return createJsonResponse({ 
    status: 'success', 
    message: '報名成功' 
  });
}

function createJsonResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}
