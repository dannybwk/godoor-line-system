<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²ç¨‹å ±åç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #ff9800;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .site-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #ff9800;
            color: white;
        }

        .btn-primary:hover {
            background: #f57c00;
        }

        .btn-outline {
            background: white;
            color: #ff9800;
            border: 2px solid #ff9800;
        }

        .btn-outline:hover {
            background: #ff9800;
            color: white;
        }

        .events-grid {
            display: grid;
            gap: 20px;
        }

        .event-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .event-card:hover {
            border-color: #ff9800;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.15);
        }

        .event-card.selected {
            border-color: #4caf50;
            background: #f1f8e9;
        }

        .event-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .event-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 15px;
        }

        .event-title {
            font-size: 20px;
            font-weight: 600;
            color: #ff9800;
            margin: 0;
        }

        .event-details {
            color: #666;
            font-size: 16px;
        }

        .event-details div {
            margin-bottom: 8px;
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .required {
            color: #f44336;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        .form-control:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #f44336;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .view-toggle {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŠ èª²ç¨‹å ±åç³»çµ±</h1>
            <p>é¸æ“‡æ‚¨æƒ³åƒåŠ çš„èª²ç¨‹</p>
        </div>

        <div id="siteInfo" class="site-info hidden">
            <strong>ğŸ“ ç•¶å‰æ“šé»ï¼š</strong><span id="currentSite"></span>
        </div>

        <div class="view-toggle">
            <button class="btn btn-primary" onclick="loadEvents()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
            <button class="btn btn-outline" onclick="clearSelection()">ğŸ—‘ï¸ æ¸…é™¤é¸æ“‡</button>
        </div>

        <div id="eventsContainer">
            <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="form-section">
            <h3 style="margin-bottom: 20px; color: #ff9800;">ğŸ“ å ±åè³‡æ–™</h3>
            <form id="signupForm">
                <div class="form-group">
                    <label class="form-label">å§“å <span class="required">*</span></label>
                    <input type="text" class="form-control" name="name" required>
                </div>

                <div class="form-group">
                    <label class="form-label">LINEåç¨± <span class="required">*</span></label>
                    <input type="text" class="form-control" name="lineName" required>
                </div>

                <div class="form-group">
                    <label class="form-label">æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">*</span></label>
                    <input type="tel" class="form-control" name="phone" required>
                </div>

                <div class="form-group">
                    <label class="form-label">é›»å­éƒµä»¶</label>
                    <input type="email" class="form-control" name="email">
                </div>

                <div class="form-group">
                    <label class="form-label">æ€§åˆ¥</label>
                    <select class="form-control" name="gender">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">å¹´é½¡</label>
                    <input type="number" class="form-control" name="age" min="1" max="120">
                </div>

                <div class="form-group">
                    <label class="form-label">å‚™è¨»</label>
                    <textarea class="form-control" name="note" rows="3"></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 18px;">
                    âœ… é€å‡ºå ±å
                </button>
            </form>
        </div>
    </div>

    <script>
        // é…ç½®
        const API_URL = 'https://script.google.com/macros/s/AKfycbxpDCRA2PJXLy8ssWwG3NO4QZzg87gmUdB1vHWjYNdf9jmz-ku0yfnovhtfz58ep0oE/exec';
        
        // ç‹€æ…‹
        let events = [];
        let selectedEventIds = [];
        
        // å¾ URL ç²å–æ“šé»åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        const siteKeyword = urlParams.get('site') || '';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            if (siteKeyword) {
                document.getElementById('siteInfo').classList.remove('hidden');
                document.getElementById('currentSite').textContent = siteKeyword;
            }
            
            loadEvents();
            setupForm();
        });

        // è¼‰å…¥æ´»å‹•
        async function loadEvents() {
            const container = document.getElementById('eventsContainer');
            container.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

            try {
                const url = `${API_URL}?mode=events&site=${encodeURIComponent(siteKeyword)}`;
                console.log('è¼‰å…¥ URL:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('æ”¶åˆ°è³‡æ–™:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                events = Array.isArray(data) ? data : data.events || [];
                console.log('æ´»å‹•æ•¸é‡:', events.length);
                
                renderEvents();
                
            } catch (error) {
                console.error('è¼‰å…¥éŒ¯èª¤:', error);
                container.innerHTML = `
                    <div class="error">
                        <h4>è¼‰å…¥å¤±æ•—</h4>
                        <p>éŒ¯èª¤ï¼š${error.message}</p>
                        <p>è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦</p>
                        <button class="btn btn-primary" onclick="loadEvents()">é‡æ–°è¼‰å…¥</button>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“æ´»å‹•åˆ—è¡¨
        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            
            if (events.length === 0) {
                container.innerHTML = `
                    <div class="error">
                        <h4>æ²’æœ‰æ‰¾åˆ°èª²ç¨‹</h4>
                        <p>ç›®å‰æ²’æœ‰å¯å ±åçš„èª²ç¨‹</p>
                    </div>
                `;
                return;
            }

            const html = events.map(event => `
                <div class="event-card" data-event-id="${event['æ´»å‹•ID']}" onclick="toggleEvent('${event['æ´»å‹•ID']}')">
                    <div class="event-header">
                        <input type="checkbox" class="event-checkbox" ${selectedEventIds.includes(event['æ´»å‹•ID']) ? 'checked' : ''}>
                        <h3 class="event-title">${event['æ´»å‹•æ¨™é¡Œ']}</h3>
                    </div>
                    <div class="event-details">
                        <div>ğŸ‘¨â€ğŸ« è¬›å¸«ï¼š${event['è¬›å¸«'] || 'å¾…ç¢ºèª'}</div>
                        <div>ğŸ“… æ—¥æœŸï¼š${formatDate(event['æ´»å‹•æ—¥æœŸ'])}</div>
                        <div>ğŸ• æ™‚é–“ï¼š${formatTime(event['é–‹å§‹æ™‚é–“'])}</div>
                        <div>ğŸ“ åœ°é»ï¼š${event['åœ°å€æˆ–åœ°é»èªªæ˜'] || 'å¾…ç¢ºèª'}</div>
                        ${event['æ´»å‹•å…§å®¹'] ? `<div>ğŸ“‹ å…§å®¹ï¼š${event['æ´»å‹•å…§å®¹']}</div>` : ''}
                        ${event['å‚™è¨»'] ? `<div>âš ï¸ å‚™è¨»ï¼š${event['å‚™è¨»']}</div>` : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="events-grid">${html}</div>`;
        }

        // åˆ‡æ›æ´»å‹•é¸æ“‡
        function toggleEvent(eventId) {
            const index = selectedEventIds.indexOf(eventId);
            const card = document.querySelector(`[data-event-id="${eventId}"]`);
            const checkbox = card.querySelector('.event-checkbox');
            
            if (index > -1) {
                selectedEventIds.splice(index, 1);
                card.classList.remove('selected');
                checkbox.checked = false;
            } else {
                selectedEventIds.push(eventId);
                card.classList.add('selected');
                checkbox.checked = true;
            }
        }

        // æ¸…é™¤é¸æ“‡
        function clearSelection() {
            selectedEventIds = [];
            document.querySelectorAll('.event-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.event-checkbox').checked = false;
            });
        }

        // è¨­ç½®è¡¨å–®
        function setupForm() {
            document.getElementById('signupForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (selectedEventIds.length === 0) {
                    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹èª²ç¨‹');
                    return;
                }

                const formData = new FormData(this);
                const submitBtn = this.querySelector('button[type="submit"]');
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'å ±åä¸­...';

                try {
                    for (const eventId of selectedEventIds) {
                        const data = new URLSearchParams({
                            action: 'register',
                            eventId: eventId,
                            name: formData.get('name'),
                            lineName: formData.get('lineName'),
                            phone: formData.get('phone'),
                            email: formData.get('email'),
                            gender: formData.get('gender'),
                            age: formData.get('age'),
                            note: formData.get('note')
                        });

                        const response = await fetch(API_URL, {
                            method: 'POST',
                            body: data
                        });

                        const result = await response.json();
                        
                        if (result.error) {
                            throw new Error(result.error);
                        }
                    }

                    alert('å ±åæˆåŠŸï¼');
                    this.reset();
                    clearSelection();
                    
                } catch (error) {
                    alert('å ±åå¤±æ•—ï¼š' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'âœ… é€å‡ºå ±å';
                }
            });
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            } catch {
                return dateStr;
            }
        }

        // æ ¼å¼åŒ–æ™‚é–“
        function formatTime(timeStr) {
            if (!timeStr) return '';
            try {
                if (timeStr.toString().includes('1899')) {
                    const date = new Date(timeStr);
                    return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                }
                return timeStr;
            } catch {
                return timeStr;
            }
        }
    </script>
</body>
</html>
