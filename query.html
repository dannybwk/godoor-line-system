<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æŸ¥è©¢æˆ‘çš„å ±åè¨˜éŒ„ - æœå¤š</title>
<!-- LIFF SDK -->
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    color: #333;
    line-height: 1.6;
    font-size: 18px;
    min-height: 100vh;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    background: #ff9800;
    color: white;
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 30px;
    text-align: center;
}

.header h1 {
    font-size: 28px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.logo-icon {
    width: 64px;
    height: 64px;
    vertical-align: middle;
    margin-right: 12px;
    border-radius: 8px;
    background: white;
    padding: 4px;
}

.back-btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid white;
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    text-decoration: none;
    display: inline-block;
    margin-bottom: 15px;
    font-size: 16px;
}

.back-btn:hover {
    background: rgba(255,255,255,0.3);
    color: white;
    text-decoration: none;
}

/* æŸ¥è©¢è¡¨å–®å€åŸŸ */
.query-section {
    background: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.query-section h2 {
    color: #ff9800;
    font-size: 24px;
    margin-bottom: 20px;
    text-align: center;
}

.query-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    font-weight: 500;
    color: #333;
    margin-bottom: 8px;
    font-size: 18px;
}

.form-control {
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 18px;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: #ff9800;
    box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
}

.btn {
    padding: 15px 30px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 18px;
    font-weight: 500;
    transition: all 0.2s;
    text-align: center;
}

.btn-primary {
    background: #ff9800;
    color: white;
}

.btn-primary:hover {
    background: #f57c00;
}

.btn-outline {
    background: white;
    color: #ff9800;
    border: 2px solid #ff9800;
}

.btn-outline:hover {
    background: #ff9800;
    color: white;
}

/* LIFF ç‹€æ…‹é¡¯ç¤º */
.liff-status {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #2196f3;
    font-size: 16px;
}

/* çµæœé¡¯ç¤ºå€åŸŸ */
.results-section {
    background: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.results-header {
    color: #ff9800;
    font-size: 24px;
    margin-bottom: 20px;
    text-align: center;
    padding-bottom: 10px;
    border-bottom: 2px solid #ff9800;
}

.record-card {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    transition: all 0.2s;
}

.record-card:hover {
    border-color: #ff9800;
    box-shadow: 0 4px 12px rgba(255, 152, 0, 0.15);
}

.record-card.upcoming {
    border-left: 6px solid #4caf50;
    background: #f1f8e9;
}

.record-card.completed {
    border-left: 6px solid #9e9e9e;
    background: #f5f5f5;
}

.record-card.cancelled {
    border-left: 6px solid #f44336;
    background: #ffebee;
}

.record-title {
    font-size: 20px;
    font-weight: bold;
    color: #ff9800;
    margin-bottom: 10px;
}

.record-details {
    color: #666;
    font-size: 16px;
    line-height: 1.5;
}

.record-details div {
    margin-bottom: 8px;
}

.status-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: bold;
    color: white;
    margin-top: 10px;
}

.status-upcoming {
    background: #4caf50;
}

.status-completed {
    background: #9e9e9e;
}

.status-cancelled {
    background: #f44336;
}

.no-records {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 18px;
}

.no-records img {
    width: 80px;
    height: 80px;
    opacity: 0.5;
    margin-bottom: 20px;
}

/* çµ±è¨ˆæ‘˜è¦ */
.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-item {
    background: #ff9800;
    color: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}

.stat-number {
    font-size: 24px;
    font-weight: bold;
    display: block;
}

.stat-label {
    font-size: 14px;
    margin-top: 5px;
}

/* è¼‰å…¥ç‹€æ…‹ */
.loading {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 18px;
}

.error {
    background: #ffebee;
    color: #c62828;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #f44336;
    margin-bottom: 20px;
}

.hidden {
    display: none;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
    .container {
        padding: 15px;
    }

    .header h1 {
        font-size: 24px;
        flex-direction: column;
        gap: 8px;
    }

    .logo-icon {
        width: 56px;
        height: 56px;
        margin-right: 0;
    }

    .query-section, .results-section {
        padding: 20px;
    }

    .summary-stats {
        grid-template-columns: repeat(2, 1fr);
    }

    .record-card {
        padding: 15px;
    }
}
</style>
</head>
<body>
<div class="container">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="header">
        <a href="index.html" class="back-btn">â† å›åˆ°èª²ç¨‹å ±å</a>
        <h1>
            <img src="https://godoor.umita.tw/wp-content/uploads/2023/10/%E6%9E%9C%E5%A4%9A-Logo-%E7%B0%A1%E5%96%AE%E5%BD%A9%E7%89%88-300x300.png" 
                 alt="æœå¤š" 
                 class="logo-icon"> 
            æŸ¥è©¢æˆ‘çš„å ±åè¨˜éŒ„
        </h1>
        <p>æª¢è¦–æ‚¨å ±åçš„æ‰€æœ‰èª²ç¨‹</p>
    </div>

    <!-- LIFF ç‹€æ…‹é¡¯ç¤º -->
    <div id="liffStatus" class="liff-status hidden">
        <strong>ğŸ”— LINE é€£ç·šç‹€æ…‹ï¼š</strong><span id="liffStatusText">æª¢æŸ¥ä¸­...</span>
    </div>

    <!-- æŸ¥è©¢è¡¨å–®å€åŸŸ -->
    <div class="query-section">
        <h2>ğŸ” è«‹è¼¸å…¥æŸ¥è©¢è³‡è¨Š</h2>
        
        <form id="queryForm" class="query-form">
            <div class="form-group">
                <label class="form-label">æŸ¥è©¢æ–¹å¼</label>
                <select class="form-control" id="queryMethod" onchange="toggleQueryFields()">
                    <option value="auto">è‡ªå‹•è­˜åˆ¥ (LINEç”¨æˆ¶)</option>
                    <option value="phone">æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢</option>
                    <option value="name">å§“å + æ‰‹æ©ŸæŸ¥è©¢</option>
                </select>
            </div>

            <!-- æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢ -->
            <div class="form-group" id="phoneGroup">
                <label class="form-label">æ‰‹æ©Ÿè™Ÿç¢¼ *</label>
                <input type="tel" class="form-control" id="phoneInput" 
                       placeholder="è«‹è¼¸å…¥å ±åæ™‚ä½¿ç”¨çš„æ‰‹æ©Ÿè™Ÿç¢¼">
            </div>

            <!-- å§“åæŸ¥è©¢ -->
            <div class="form-group hidden" id="nameGroup">
                <label class="form-label">å§“å *</label>
                <input type="text" class="form-control" id="nameInput" 
                       placeholder="è«‹è¼¸å…¥å ±åæ™‚ä½¿ç”¨çš„å§“å">
            </div>

            <!-- æ“šé»ç¯©é¸ -->
            <div class="form-group">
                <label class="form-label">æ“šé»ç¯©é¸ (é¸å¡«)</label>
                <select class="form-control" id="siteFilter">
                    <option value="">æ‰€æœ‰æ“šé»</option>
                    <option value="@æ­¡éŠ€å­¸å ‚">æ­¡éŠ€å­¸å ‚</option>
                    <option value="@æ¸¬è©¦æ“šé»">æ¸¬è©¦æ“šé»</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary">
                ğŸ” æŸ¥è©¢æˆ‘çš„å ±åè¨˜éŒ„
            </button>
        </form>
    </div>

    <!-- æŸ¥è©¢çµæœå€åŸŸ -->
    <div id="resultsSection" class="results-section hidden">
        <h3 class="results-header">ğŸ“‹ æˆ‘çš„å ±åè¨˜éŒ„</h3>
        
        <!-- çµ±è¨ˆæ‘˜è¦ -->
        <div id="summaryStats" class="summary-stats">
            <div class="stat-item">
                <span class="stat-number" id="totalCount">0</span>
                <span class="stat-label">ç¸½å ±åæ•¸</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="upcomingCount">0</span>
                <span class="stat-label">å³å°‡åˆ°ä¾†</span>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="completedCount">0</span>
                <span class="stat-label">å·²å®Œæˆ</span>
            </div>
        </div>

        <!-- å ±åè¨˜éŒ„åˆ—è¡¨ -->
        <div id="recordsList">
            <!-- å‹•æ…‹ç”Ÿæˆå ±åè¨˜éŒ„ -->
        </div>
    </div>

    <!-- é é¢åº•éƒ¨ -->
    <div style="text-align: center; padding: 40px 20px 20px; margin-top: 50px; border-top: 1px solid #e0e0e0;">
        <div style="color: #666; font-size: 16px; margin-bottom: 15px;">Powered by æœå¤š</div>
        <img src="https://godoor.umita.tw/wp-content/uploads/2023/10/%E6%9E%9C%E5%A4%9A-Logo-%E7%B0%A1%E5%96%AE%E5%BD%A9%E7%89%88-300x300.png" 
             alt="æœå¤š" 
             style="width: 80px; height: 80px; border-radius: 8px; opacity: 0.8;">
    </div>
</div>

<script>
// é…ç½®
const API_URL = 'https://script.google.com/macros/s/AKfycbxpDCRA2PJXLy8ssWwG3NO4QZzg87gmUdB1vHWjYNdf9jmz-ku0yfnovhtfz58ep0oE/exec';
const LIFF_ID = '2007618883-ewZnj9Py';

// å…¨åŸŸè®Šæ•¸
let userProfile = null;
let isLiffReady = false;
let currentRecords = [];

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializePage();
    setupEventListeners();
    initializeLiff();
});

/**
 * åˆå§‹åŒ–é é¢
 */
function initializePage() {
    // å¾ URL åƒæ•¸ç²å–æ“šé»è³‡è¨Š
    const urlParams = new URLSearchParams(window.location.search);
    const siteParam = urlParams.get('site');
    
    if (siteParam) {
        document.getElementById('siteFilter').value = siteParam;
    }
}

/**
 * è¨­å®šäº‹ä»¶ç›£è½å™¨
 */
function setupEventListeners() {
    document.getElementById('queryForm').addEventListener('submit', handleQuery);
}

/**
 * åˆå§‹åŒ– LIFF
 */
async function initializeLiff() {
    try {
        console.log('ğŸ”„ åˆå§‹åŒ– LIFF...');
        
        if (typeof liff === 'undefined') {
            console.log('âš ï¸ ä¸åœ¨ LIFF ç’°å¢ƒä¸­');
            showLiffStatus('ä¸åœ¨ LINE ç’°å¢ƒä¸­ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æŸ¥è©¢è³‡è¨Š', 'warning');
            return;
        }
        
        await liff.init({ liffId: LIFF_ID });
        
        if (liff.isLoggedIn()) {
            console.log('âœ… LIFF ç™»å…¥æˆåŠŸ');
            await getUserProfile();
            isLiffReady = true;
            showLiffStatus(`å·²é€£ç·š LINE å¸³è™Ÿï¼š${userProfile.displayName}`, 'success');
            
            // è‡ªå‹•è¨­å®šæŸ¥è©¢æ–¹å¼ç‚ºè‡ªå‹•è­˜åˆ¥
            document.getElementById('queryMethod').value = 'auto';
            toggleQueryFields();
            
        } else {
            console.log('âŒ LIFF æœªç™»å…¥');
            showLiffStatus('è«‹åœ¨ LINE ä¸­é–‹å•Ÿæ­¤é é¢', 'warning');
        }
        
    } catch (error) {
        console.error('âŒ LIFF åˆå§‹åŒ–å¤±æ•—:', error);
        showLiffStatus('LINE é€£ç·šå¤±æ•—ï¼Œè«‹æ‰‹å‹•æŸ¥è©¢', 'error');
    }
}

/**
 * å–å¾—ä½¿ç”¨è€…è³‡æ–™
 */
async function getUserProfile() {
    try {
        userProfile = await liff.getProfile();
        console.log('ğŸ‘¤ LIFF ä½¿ç”¨è€…è³‡æ–™:', userProfile);
    } catch (error) {
        console.error('âŒ å–å¾—ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:', error);
    }
}

/**
 * é¡¯ç¤º LIFF ç‹€æ…‹
 */
function showLiffStatus(message, type = 'info') {
    const statusDiv = document.getElementById('liffStatus');
    const statusText = document.getElementById('liffStatusText');
    
    statusText.textContent = message;
    statusDiv.classList.remove('hidden');
    
    // æ ¹æ“šé¡å‹è¨­å®šé¡è‰²
    statusDiv.style.backgroundColor = type === 'success' ? '#e8f5e8' : 
                                    type === 'warning' ? '#fff3e0' : 
                                    type === 'error' ? '#ffebee' : '#e3f2fd';
    statusDiv.style.borderLeftColor = type === 'success' ? '#4caf50' : 
                                     type === 'warning' ? '#ff9800' : 
                                     type === 'error' ? '#f44336' : '#2196f3';
}

/**
 * åˆ‡æ›æŸ¥è©¢æ¬„ä½é¡¯ç¤º
 */
function toggleQueryFields() {
    const method = document.getElementById('queryMethod').value;
    const phoneGroup = document.getElementById('phoneGroup');
    const nameGroup = document.getElementById('nameGroup');
    const phoneInput = document.getElementById('phoneInput');
    const nameInput = document.getElementById('nameInput');
    
    if (method === 'auto') {
        phoneGroup.classList.add('hidden');
        nameGroup.classList.add('hidden');
        phoneInput.required = false;
        nameInput.required = false;
    } else if (method === 'phone') {
        phoneGroup.classList.remove('hidden');
        nameGroup.classList.add('hidden');
        phoneInput.required = true;
        nameInput.required = false;
    } else if (method === 'name') {
        phoneGroup.classList.remove('hidden');
        nameGroup.classList.remove('hidden');
        phoneInput.required = true;
        nameInput.required = true;
    }
}

/**
 * è™•ç†æŸ¥è©¢è«‹æ±‚
 */
async function handleQuery(e) {
    e.preventDefault();
    
    const method = document.getElementById('queryMethod').value;
    const phone = document.getElementById('phoneInput').value.trim();
    const name = document.getElementById('nameInput').value.trim();
    const site = document.getElementById('siteFilter').value;
    
    // é©—è­‰è¼¸å…¥
    if (method === 'auto' && !isLiffReady) {
        showError('ç„¡æ³•è‡ªå‹•è­˜åˆ¥ï¼Œè«‹é¸æ“‡å…¶ä»–æŸ¥è©¢æ–¹å¼');
        return;
    }
    
    if (method === 'phone' && !phone) {
        showError('è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼');
        return;
    }
    
    if (method === 'name' && (!name || !phone)) {
        showError('è«‹è¼¸å…¥å§“åå’Œæ‰‹æ©Ÿè™Ÿç¢¼');
        return;
    }
    
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    showLoading();
    
    try {
        const queryParams = {
            action: 'queryUserRecords',
            method: method,
            site: site
        };
        
        if (method === 'auto') {
            queryParams.lineId = userProfile.userId;
            queryParams.lineName = userProfile.displayName;
        } else if (method === 'phone') {
            queryParams.phone = phone;
        } else if (method === 'name') {
            queryParams.name = name;
            queryParams.phone = phone;
        }
        
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(queryParams)
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentRecords = result.records || [];
            displayResults(currentRecords);
        } else {
            showError(result.error || 'æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
        
    } catch (error) {
        console.error('æŸ¥è©¢éŒ¯èª¤:', error);
        showError('ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦');
    }
}

/**
 * é¡¯ç¤ºæŸ¥è©¢çµæœ
 */
function displayResults(records) {
    const resultsSection = document.getElementById('resultsSection');
    const recordsList = document.getElementById('recordsList');
    
    resultsSection.classList.remove('hidden');
    
    if (records.length === 0) {
        recordsList.innerHTML = `
            <div class="no-records">
                <img src="https://godoor.umita.tw/wp-content/uploads/2023/10/%E6%9E%9C%E5%A4%9A-Logo-%E7%B0%A1%E5%96%AE%E5%BD%A9%E7%89%88-300x300.png" alt="æœå¤š">
                <div>ç›®å‰æ²’æœ‰æ‰¾åˆ°å ±åè¨˜éŒ„</div>
                <div style="font-size: 16px; color: #999; margin-top: 10px;">
                    è«‹ç¢ºèªè¼¸å…¥çš„è³‡è¨Šæ˜¯å¦æ­£ç¢ºï¼Œæˆ–è¯ç¹«æœå‹™äººå“¡
                </div>
            </div>
        `;
        updateSummaryStats(0, 0, 0);
        return;
    }
    
    // åˆ†é¡è¨˜éŒ„
    const now = new Date();
    const upcoming = records.filter(r => new Date(r['æ´»å‹•æ—¥æœŸ']) > now);
    const completed = records.filter(r => new Date(r['æ´»å‹•æ—¥æœŸ']) <= now);
    
    // æ›´æ–°çµ±è¨ˆ
    updateSummaryStats(records.length, upcoming.length, completed.length);
    
    // æ’åºï¼šå³å°‡åˆ°ä¾†çš„åœ¨å‰ï¼ŒæŒ‰æ—¥æœŸæ’åº
    const sortedRecords = [...upcoming, ...completed].sort((a, b) => {
        return new Date(b['æ´»å‹•æ—¥æœŸ']) - new Date(a['æ´»å‹•æ—¥æœŸ']);
    });
    
    // æ¸²æŸ“è¨˜éŒ„å¡ç‰‡
    recordsList.innerHTML = sortedRecords.map(record => renderRecordCard(record)).join('');
}

/**
 * æ¸²æŸ“å–®å€‹å ±åè¨˜éŒ„å¡ç‰‡
 */
function renderRecordCard(record) {
    const eventDate = new Date(record['æ´»å‹•æ—¥æœŸ']);
    const now = new Date();
    const isUpcoming = eventDate > now;
    
    const statusClass = isUpcoming ? 'upcoming' : 'completed';
    const statusBadge = isUpcoming ? 'status-upcoming' : 'status-completed';
    const statusText = isUpcoming ? 'å³å°‡åˆ°ä¾†' : 'å·²å®Œæˆ';
    
    return `
        <div class="record-card ${statusClass}">
            <div class="record-title">${record['æ´»å‹•æ¨™é¡Œ'] || 'æœªè¨­å®šæ¨™é¡Œ'}</div>
            <div class="record-details">
                <div>ğŸ‘¨â€ğŸ« <strong>è¬›å¸«ï¼š</strong>${record['è¬›å¸«'] || 'å¾…ç¢ºèª'}</div>
                <div>ğŸ“… <strong>æ—¥æœŸï¼š</strong>${formatDate(record['æ´»å‹•æ—¥æœŸ'])}</div>
                <div>ğŸ• <strong>æ™‚é–“ï¼š</strong>${formatTime(record['é–‹å§‹æ™‚é–“'])}</div>
                <div>ğŸ“ <strong>åœ°é»ï¼š</strong>${record['åœ°å€æˆ–åœ°é»èªªæ˜'] || 'è©³è¦‹æ´»å‹•èªªæ˜'}</div>
                <div>ğŸ“ <strong>å ±åæ‰‹æ©Ÿï¼š</strong>${record['æ‰‹æ©Ÿè™Ÿç¢¼']}</div>
                <div>ğŸ“ <strong>å ±åæ™‚é–“ï¼š</strong>${formatDateTime(record['å ±åæ™‚é–“'])}</div>
                ${record['è‡ªè¨‚æ¬„ä½å›ç­”'] ? `<div>ğŸ’¬ <strong>å•é¡Œå›ç­”ï¼š</strong>${record['è‡ªè¨‚æ¬„ä½å›ç­”']}</div>` : ''}
                ${record['å‚™è¨»'] ? `<div>ğŸ“‹ <strong>å‚™è¨»ï¼š</strong>${record['å‚™è¨»']}</div>` : ''}
            </div>
            <span class="status-badge ${statusBadge}">${statusText}</span>
        </div>
    `;
}

/**
 * æ›´æ–°çµ±è¨ˆæ‘˜è¦
 */
function updateSummaryStats(total, upcoming, completed) {
    document.getElementById('totalCount').textContent = total;
    document.getElementById('upcomingCount').textContent = upcoming;
    document.getElementById('completedCount').textContent = completed;
}

/**
 * é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
 */
function showLoading() {
    const resultsSection = document.getElementById('resultsSection');
    resultsSection.classList.remove('hidden');
    resultsSection.innerHTML = `
        <div class="loading">
            ğŸ”„ æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...
        </div>
    `;
}

/**
 * é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
 */
function showError(message) {
    const resultsSection = document.getElementById('resultsSection');
    resultsSection.classList.remove('hidden');
    resultsSection.innerHTML = `
        <div class="error">
            <h4>âŒ æŸ¥è©¢å¤±æ•—</h4>
            <p>${message}</p>
        </div>
    `;
}

/**
 * æ ¼å¼åŒ–æ—¥æœŸ
 */
function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
        const date = new Date(dateStr);
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const weekday = weekdays[date.getDay()];
        return `${month}/${day} (${weekday})`;
    } catch {
        return dateStr;
    }
}

/**
 * æ ¼å¼åŒ–æ™‚é–“
 */
function formatTime(timeStr) {
    if (!timeStr) return '';
    try {
        if (timeStr.toString().includes('1899')) {
            const date = new Date(timeStr);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        return timeStr;
    } catch {
        return timeStr;
    }
}

/**
 * æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
 */
function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '';
    try {
        const date = new Date(dateTimeStr);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}/${month}/${day} ${hours}:${minutes}`;
    } catch {
        return dateTimeStr;
    }
}

// é é¢å¯è¦‹æ€§è®Šæ›´æ™‚é‡æ–°æª¢æŸ¥ LIFF ç‹€æ…‹
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && typeof liff !== 'undefined') {
        // é é¢é‡æ–°å¯è¦‹æ™‚ï¼Œé‡æ–°æª¢æŸ¥ LIFF ç‹€æ…‹
        if (liff.isLoggedIn() && !isLiffReady) {
            initializeLiff();
        }
    }
});
</script>
</body>
</html>
